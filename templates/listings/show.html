<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ listing.title }} - NEXUS Marketplace</title>
    <meta name="description" content="{{ listing.description | truncate(length=160) }}">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* Layout */
        .container { max-width: 1280px; margin: 0 auto; padding: 8rem 1.5rem 0; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        .product-detail-layout { display: grid; grid-template-columns: 3fr 2fr; gap: 2rem; }
        @media (max-width: 768px) { .product-detail-layout { grid-template-columns: 1fr; } }
        .space-y-6 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 1.5rem; }
        .space-y-4 > *:not([hidden]) ~ *:not([hidden]) { margin-top: 1rem; }

        /* Breadcrumb */
        .breadcrumb { display: flex; align-items: center; font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 2rem; }
        .breadcrumb a { color: hsl(var(--muted-foreground)); text-decoration: none; transition: color 0.2s; }
        .breadcrumb a:hover { color: hsl(var(--foreground)); }
        .breadcrumb-separator { margin: 0 0.5rem; width: 1rem; height: 1rem; display: inline-flex; align-items: center; justify-content: center; color: hsl(var(--muted-foreground)); }
        .breadcrumb-current { color: hsl(var(--accent)); }

        /* Product Image */
        .product-detail-image-main { width: 100%; aspect-ratio: 16/9; background-color: #242424; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; overflow: hidden; cursor: zoom-in; }
        .product-detail-image-main img { width: 100%; height: 100%; object-fit: contain; }
        .product-detail-image-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: hsl(var(--muted-foreground)); font-size: 1rem; }
        .product-detail-image-placeholder svg { margin-bottom: 0.5rem; }

        /* Thumbnails */
        .product-detail-thumbnails { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .product-detail-thumbnail { width: 60px; height: 60px; border: 2px solid transparent; border-radius: 0.25rem; overflow: hidden; cursor: pointer; transition: border-color 0.2s; }
        .product-detail-thumbnail:hover, .product-detail-thumbnail.active { border-color: hsl(var(--accent)); }
        .product-detail-thumbnail img { width: 100%; height: 100%; object-fit: cover; }

        /* Tabs */
        .tabs-container { background-color: #242424; border: 1px solid var(--color-border); border-radius: 0.5rem; overflow: hidden; }
        .tabs-nav { display: flex; border-bottom: 1px solid var(--color-border); }
        .tab-button { padding: 0.75rem 1.5rem; background: transparent; border: none; color: hsl(var(--muted-foreground)); cursor: pointer; transition: all 0.2s; font-size: 0.875rem; }
        .tab-button:hover { color: hsl(var(--foreground)); }
        .tab-button.active { color: hsl(var(--accent)); border-bottom: 2px solid hsl(var(--accent)); }
        .tab-content { padding: 1.5rem; display: none; }
        .tab-content.active { display: block; }

        /* Product Info Card */
        .product-info-sticky { position: sticky; top: 8rem; }
        .category-badge-yellow { background-color: hsla(var(--accent), 0.1); color: hsl(var(--accent)); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; display: inline-block; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-bold { font-weight: 700; }
        .price-conversion { margin-top: 0.5rem; }
        .price-primary { font-size: 1.5rem; font-weight: 700; color: hsl(var(--accent)); }
        .price-secondary { font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-left: 0.5rem; }

        /* Vendor Card */
        .vendor-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background-color: hsla(var(--foreground), 0.05); border-radius: 0.5rem; text-decoration: none; transition: background-color 0.2s; }
        .vendor-card:hover { background-color: hsla(var(--foreground), 0.1); }
        .vendor-card-avatar svg { width: 2rem; height: 2rem; stroke: hsl(var(--muted-foreground)); }
        .vendor-card-info { flex-grow: 1; }
        .vendor-card-label { font-size: 0.75rem; color: hsl(var(--muted-foreground)); }
        .vendor-card-name { font-size: 1rem; font-weight: 500; color: hsl(var(--foreground)); }
        .vendor-card-arrow svg { width: 1rem; height: 1rem; stroke: hsl(var(--muted-foreground)); }

        /* Trust Badges */
        .trust-badges-inline { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
        .trust-badge-inline { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: hsl(var(--muted-foreground)); }
        .trust-badge-inline svg { width: 1.25rem; height: 1.25rem; stroke: hsl(var(--accent)); }

        /* Quantity Stepper */
        .quantity-stepper { display: inline-flex; border: 1px solid var(--color-border); border-radius: 0.25rem; overflow: hidden; }
        .quantity-stepper-btn { background: transparent; border: none; color: hsl(var(--foreground)); padding: 0.5rem 0.75rem; cursor: pointer; transition: background-color 0.2s; }
        .quantity-stepper-btn:hover { background-color: hsla(var(--foreground), 0.1); }
        .quantity-stepper-value { padding: 0.5rem 0.75rem; border-left: 1px solid var(--color-border); border-right: 1px solid var(--color-border); color: hsl(var(--foreground)); font-size: 1rem; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; padding: 0.5rem 1rem; background-color: var(--color-accent); color: var(--color-background); border: none; cursor: pointer; }
        .btn-primary { background-color: hsl(var(--accent)); color: hsl(var(--background)); }
        .btn-outline { background-color: transparent; border: 1px solid hsl(var(--border)); color: hsl(var(--foreground)); }
        .btn-lg { padding: 0.75rem 1.5rem; font-size: 1rem; }
        .w-full { width: 100%; }
        .flex-1 { flex: 1; }

        /* Shipping Form */
        #shipping-form { margin-top: 1.5rem; padding: 1.5rem; background-color: #242424; border: 1px solid var(--color-border); border-radius: 0.5rem; }
        #shipping-form .input, #shipping-form .textarea { background-color: #1A1A1A; border-color: var(--color-border); color: hsl(var(--foreground)); }
        #shipping-form .label { color: hsl(var(--foreground)); font-weight: 500; }

        /* Image Modal */
        .image-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .image-modal.hidden { display: none; }
        .image-modal img { max-width: 90%; max-height: 90%; object-fit: contain; }

        /* Lucide Icons */
        .lucide { stroke: currentColor; stroke-width: 2; fill: none; }
        .lucide-sm { width: 1rem; height: 1rem; stroke: currentColor; stroke-width: 2; fill: none; }

    </style>
</head>
<body>
    {% include "header.html" %}

    <main class="container">
        <!-- Product Detail Container -->
        <div class="container py-8">
          <!-- Breadcrumb -->
          <nav class="breadcrumb">
            <a href="/">Home</a>
            <span class="breadcrumb-separator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </span>
            <a href="/listings">Listings</a>
            <span class="breadcrumb-separator">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </span>
            <span class="breadcrumb-current">{{ listing.title }}</span>
          </nav>

          <!-- Product Detail Layout (60/40) -->
          <div class="product-detail-layout">
            <!-- Left Column: Images + Tabs (60%) -->
            <div class="space-y-6">
              <!-- Main Image -->
              {% if images and images | length > 0 %}
              <div class="product-detail-image-main" onclick="openImageModal()">
                <img
                  id="main-image"
                  src="/api/listings/{{ listing.id }}/images/{{ images[0] }}"
                  alt="{{ listing.title }}"
                  loading="lazy"
                />
              </div>

              <!-- Thumbnails -->
              {% if images | length > 1 %}
              <div class="product-detail-thumbnails">
                {% for image_cid in images %}
                <div
                  class="product-detail-thumbnail {% if loop.index0 == 0 %}active{% endif %}"
                  data-image-cid="{{ image_cid }}"
                  onclick="changeMainImage(this, event)"
                >
                  <img
                    src="/api/listings/{{ listing.id }}/images/{{ image_cid }}"
                    alt="{{ listing.title }} - Image {{ loop.index }}"
                    loading="lazy"
                  />
                </div>
                {% endfor %}
              </div>
              {% endif %}
              {% else %}
              <!-- No Images Placeholder -->
              <div class="product-detail-image-main">
                <div class="product-detail-image-placeholder">
                  <svg class="lucide" viewBox="0 0 24 24" style="width: 4rem; height: 4rem;">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                    <circle cx="9" cy="9" r="2"/>
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                  </svg>
                  <span>No images available</span>
                </div>
              </div>
              {% endif %}

              <!-- Tabs: Description / Features / Reviews -->
              <div class="tabs-container">
                <div class="tabs-nav">
                  <button class="tab-button active" onclick="switchTab(event, 'description')">Description</button>
                  <button class="tab-button" onclick="switchTab(event, 'details')">Details</button>
                </div>

                <!-- Tab Content: Description -->
                <div id="tab-description" class="tab-content active">
                  <div class="text-base" style="color: hsl(var(--muted-foreground)); line-height: 1.7;">
                    {{ listing.description | safe }}
                  </div>
                </div>

                <!-- Tab Content: Details -->
                <div id="tab-details" class="tab-content">
                  <div class="space-y-4" style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">
                    <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                      <strong style="color: hsl(var(--foreground));">Category:</strong>
                      <span class="category-badge-yellow">{{ listing.category | upper }}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                      <strong style="color: hsl(var(--foreground));">Listing ID:</strong>
                      <span>{{ listing.id }}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 140px 1fr; gap: 0.5rem;">
                      <strong style="color: hsl(var(--foreground));">Status:</strong>
                      <span class="badge badge-accent">{{ listing.status | upper }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Related Products -->
              {% if related_products and related_products | length > 0 %}
              <div class="related-products-section">
                <h2 class="related-products-title">Related Products</h2>
                <div class="related-products-grid">
                  {% for product in related_products %}
                  <a href="/listings/{{ product.id }}" class="product-card">
                    <div class="product-card-image">
                      {% if product.images_ipfs_cids %}
                      {% set product_images = product.images_ipfs_cids | from_json %}
                      {% if product_images and product_images | length > 0 %}
                      <img src="/api/listings/{{ product.id }}/images/{{ product_images[0] }}" alt="{{ product.title }}" />
                      {% endif %}
                      {% endif %}
                    </div>
                    <div class="product-card-content">
                      <div class="product-card-category">{{ product.category | upper }}</div>
                      <h3 class="product-card-title">{{ product.title }}</h3>
                      <div class="product-card-footer">
                        <div class="product-card-price">
                          <span class="product-card-price-value">{{ (product.price_xmr / 1000000000000) | round(precision=4) }} XMR</span>
                          <span class="product-card-price-currency">Monero</span>
                        </div>
                      </div>
                    </div>
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Right Column: Product Info Card (40%) -->
            <div>
              <div class="card product-info-sticky" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Category Badge -->
                <span class="category-badge-yellow">{{ listing.category | upper }}</span>

                <!-- Title -->
                <h1 class="text-3xl font-bold" style="color: hsl(var(--foreground)); margin: 0;">
                  {{ listing.title }}
                </h1>

                <!-- Price with USD Conversion -->
                <div class="price-conversion">
                  <span class="price-primary">{{ price_display | round(precision=4) }} XMR</span>
                  {% if price_usd %}
                  <span class="price-secondary">Approximately ${{ price_usd | round }} USD</span>
                  {% endif %}
                </div>

                <!-- Vendor Card -->
                {% if vendor %}
                <a href="/vendor/{{ vendor.id }}" class="vendor-card">
                  <div class="vendor-card-avatar">
                    <svg class="lucide" viewBox="0 0 24 24">
                      <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                      <circle cx="12" cy="7" r="4"/>
                    </svg>
                  </div>
                  <div class="vendor-card-info">
                    <div class="vendor-card-label">Sold By</div>
                    <div class="vendor-card-name">{{ vendor.username }}</div>
                  </div>
                  <div class="vendor-card-arrow">
                    <svg class="lucide-sm" viewBox="0 0 24 24">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </div>
                </a>
                {% endif %}

                <!-- Trust Badges -->
                <div class="trust-badges-inline">
                  <div class="trust-badge-inline">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <span>Secure Escrow</span>
                  </div>
                  <div class="trust-badge-inline">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    <span>Monero Only</span>
                  </div>
                </div>

                <!-- Quantity Selector -->
                <div>
                  <label class="text-sm font-medium" style="display: block; margin-bottom: 0.5rem; color: hsl(var(--foreground));">
                    Quantity
                  </label>
                  <div class="quantity-stepper">
                    <button
                      type="button"
                      class="quantity-stepper-btn"
                      onclick="decreaseQuantity()"
                      aria-label="Decrease quantity"
                    >
                      <svg class="lucide-sm" viewBox="0 0 24 24">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                    <span id="quantity-display" class="quantity-stepper-value">1</span>
                    <button
                      type="button"
                      class="quantity-stepper-btn"
                      onclick="increaseQuantity()"
                      aria-label="Increase quantity"
                    >
                      <svg class="lucide-sm" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <!-- Add to Cart Button -->
                <button
                  type="button"
                  class="btn btn-primary w-full btn-lg"
                  onclick="showShippingForm()"
                >
                  <svg class="lucide-sm" viewBox="0 0 24 24">
                    <circle cx="8" cy="21" r="1"/>
                    <circle cx="19" cy="21" r="1"/>
                    <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                  </svg>
                  Add to Cart
                </button>

                <!-- Shipping Form (Initially Hidden) -->
                <div id="shipping-form" style="display: none;">
                  <form hx-post="/api/cart" hx-swap="outerHTML" class="space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <input type="hidden" name="listing_id" value="{{ listing.id }}" />
                    <input type="hidden" id="quantity-input" name="quantity" value="1" />

                    <div class="space-y-2">
                      <label for="shipping_name" class="text-sm font-medium">Recipient Name</label>
                      <input
                        id="shipping_name"
                        name="shipping_name"
                        type="text"
                        placeholder="Full name"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                        required
                      />
                    </div>

                    <div class="space-y-2">
                      <label for="shipping_address" class="text-sm font-medium">Shipping Address</label>
                      <textarea
                        id="shipping_address"
                        name="shipping_address"
                        rows="3"
                        placeholder="Street, City, Postal Code, Country"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                        required
                      ></textarea>
                    </div>

                    <div class="flex gap-2">
                      <button type="submit" class="btn btn-primary flex-1">
                        Confirm & Add to Cart
                      </button>
                      <button type="button" class="btn btn-outline" onclick="hideShippingForm()">
                        Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Modal (Fullscreen) -->
        <div id="image-modal" class="image-modal hidden" onclick="closeImageModal()">
          <img id="modal-image" src="" alt="Full size product image" />
        </div>
    </main>

    <script src="/static/js/lucide.min.js"></script>
    <script src="/static/js/base.js"></script>
    <script src="/static/js/show-listing.js" defer></script>
    <script>
      lucide.createIcons();
    </script>
</body>
</html>