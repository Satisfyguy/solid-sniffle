{% extends "base.html" %}

{% block title %}{{ listing.title | upper }} — AMAZAWN{% endblock %}

{% block content %}
<div class="container">
    <!-- Back button -->
    <div style="margin-bottom: 40px;">
        <a href="/listings" style="color: #888; text-decoration: none; font-size: 11px; letter-spacing: 1px; text-transform: uppercase;">
            ← BACK TO LISTINGS
        </a>
    </div>

    <div class="card" style="max-width: 1000px; margin: 0 auto;">
        <!-- Listing header -->
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px; border-bottom: 1px solid #2a2a2a; padding-bottom: 20px;">
            <div>
                <h1 style="font-size: 24px; font-weight: normal; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px;">
                    {{ listing.title | upper }}
                </h1>
                <div style="display: flex; gap: 20px; font-size: 11px; color: #888; letter-spacing: 1px; text-transform: uppercase;">
                    <span>VENDOR: {{ listing.vendor_username | upper }}</span>
                    <span class="separator">—</span>
                    <span>STOCK: {{ listing.stock }}</span>
                </div>
            </div>
            <span class="status-badge status-{{ listing.status }}">{{ listing.status | upper }}</span>
        </div>

        <!-- Description -->
        <div style="margin-bottom: 40px;">
            <h2 style="font-size: 12px; letter-spacing: 2px; text-transform: uppercase; color: #aaa; margin-bottom: 15px;">
                — DESCRIPTION
            </h2>
            <p style="color: #f5f5f5; line-height: 1.8; font-size: 13px;">
                {{ listing.description }}
            </p>
        </div>

        <!-- Price -->
        <div style="margin-bottom: 40px; padding: 20px; border: 1px solid #2a2a2a; background-color: #1a1a1a;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span style="display: block; font-size: 10px; color: #888; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px;">
                        UNIT PRICE
                    </span>
                    <span style="font-size: 28px; font-weight: bold; color: #f5f5f5; letter-spacing: 2px;">
                        {{ listing.price_xmr }}
                    </span>
                    <span style="font-size: 12px; color: #888; margin-left: 8px;">XMR</span>
                </div>
            </div>
        </div>

        <!-- Order form (buyer only) -->
        {% if logged_in and role == "buyer" and listing.status == "active" and listing.stock > 0 %}
        <div style="border-top: 1px solid #2a2a2a; padding-top: 40px; margin-top: 40px;">
            <h2 style="font-size: 14px; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 20px;">
                — PLACE ORDER
            </h2>

            <form hx-post="/api/orders" hx-target="#order-result" hx-swap="innerHTML">
                <input type="hidden" name="listing_id" value="{{ listing.id }}">

                <div class="form-group">
                    <label for="quantity">QUANTITY</label>
                    <input
                        type="number"
                        id="quantity"
                        name="quantity"
                        min="1"
                        max="{{ listing.stock }}"
                        value="1"
                        required
                    >
                    <small>AVAILABLE: {{ listing.stock }} UNITS</small>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #2a2a2a; background-color: #1a1a1a;">
                    <span style="font-size: 10px; color: #888; letter-spacing: 1px; text-transform: uppercase;">
                        TOTAL PRICE
                    </span>
                    <div style="font-size: 18px; color: #f5f5f5; margin-top: 5px;">
                        <span id="total-price">{{ listing.price_xmr }} XMR</span>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    CREATE ESCROW ORDER →
                </button>
            </form>

            <div id="order-result" style="margin-top: 20px;"></div>
        </div>
        {% endif %}

        <!-- Vendor actions -->
        {% if logged_in and role == "vendor" and listing.vendor_id == user_id %}
        <div style="border-top: 1px solid #2a2a2a; padding-top: 40px; margin-top: 40px; display: flex; gap: 15px;">
            <a href="/listings/{{ listing.id }}/edit" class="btn btn-secondary" style="flex: 1;">
                EDIT LISTING
            </a>
            <button
                hx-delete="/api/listings/{{ listing.id }}"
                hx-confirm="DELETE THIS LISTING? THIS CANNOT BE UNDONE."
                hx-target="body"
                class="btn btn-danger"
                style="flex: 1;"
            >
                DELETE
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Dynamic total price calculation
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    const totalPriceSpan = document.getElementById('total-price');
    const unitPrice = {{ listing.price_xmr | json_encode() | safe }};

    if (quantityInput && totalPriceSpan) {
        quantityInput.addEventListener('input', function() {
            const quantity = parseInt(this.value) || 1;
            const total = (unitPrice * quantity).toFixed(12);
            totalPriceSpan.textContent = total + ' XMR';
        });
    }
});
</script>
{% endblock %}
