{% extends "base-nexus.html" %}

{% block title %}NEXUS ‚Äî Anonymous Marketplace{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/nexus-true.css">
{% endblock %}

{% block content %}

{# TRUE NEXUS HERO - Full Screen with Animated Letters #}
<section class="nexus-hero-true">
  {# Background Pattern with Wave Animation #}
  <div class="nexus-hero-pattern" style="background-image: url('/static/hero-pattern.png');"></div>

  {# Animated Grid Lines #}
  <div class="nexus-hero-grid"></div>

  {# Floating Geometric Shapes #}
  <div class="nexus-floating-shape nexus-floating-shape-1"></div>
  <div class="nexus-floating-shape nexus-floating-shape-2"></div>
  <div class="nexus-floating-shape nexus-floating-shape-3"></div>

  {# Content #}
  <div class="nexus-hero-content-true">
    {# Top Text #}
    <div class="nexus-hero-top-text">
      ANONYMOUS ‚Ä¢ SECURE ‚Ä¢ DECENTRALIZED
    </div>

    {# Main Title with Interactive Letters #}
    <h1 class="nexus-hero-title-true" id="nexus-title">
      <span class="nexus-animated-letter" data-letter="N" role="button" tabindex="0" aria-label="Animate letter N">N</span>
      <span class="nexus-animated-letter nexus-letter-e" data-letter="E" role="button" tabindex="0" aria-label="Animate letter E">
        <span class="nexus-letter-e-invisible">E</span>
        <span class="nexus-letter-e-lines">
          <span class="nexus-letter-e-line"></span>
          <span class="nexus-letter-e-line"></span>
          <span class="nexus-letter-e-line"></span>
        </span>
      </span>
      <span class="nexus-animated-letter" data-letter="X" role="button" tabindex="0" aria-label="Animate letter X">X</span>
      <span class="nexus-animated-letter" data-letter="U" role="button" tabindex="0" aria-label="Animate letter U">U</span>
      <span class="nexus-animated-letter" data-letter="S" role="button" tabindex="0" aria-label="Animate letter S">S</span>
    </h1>

    {# Subtitle #}
    <p class="nexus-hero-subtitle-true">
      UNDERGROUND ‚Ä¢ MARKETPLACE
    </p>

    {# Stats #}
    <div class="nexus-hero-stats">
      <div class="nexus-hero-stat">
        <div class="nexus-hero-stat-value">{{ listings | length | default(value=1337) }}</div>
        <div class="nexus-hero-stat-label">LISTINGS</div>
      </div>
      <div class="nexus-hero-stat">
        <div class="nexus-hero-stat-value">420</div>
        <div class="nexus-hero-stat-label">VENDORS</div>
      </div>
      <div class="nexus-hero-stat">
        <div class="nexus-hero-stat-value">100%</div>
        <div class="nexus-hero-stat-label">ANONYMOUS</div>
      </div>
    </div>
  </div>

  {# Scroll Indicator #}
  <div class="nexus-scroll-indicator">
    <div class="nexus-scroll-text">SCROLL</div>
    <div class="nexus-scroll-line"></div>
  </div>
</section>

{# Browse Categories Section #}
<section id="categories" style="padding: 6rem 0; background: hsl(0, 0%, 5%);">
  <div style="max-width: 1400px; margin: 0 auto; padding: 0 1.5rem;">
    <div style="margin-bottom: 4rem; text-align: center;">
      <h2 class="nexus-section-title-huge">
        BROWSE CATEGORIES
      </h2>
      <p class="nexus-section-subtitle-bold">
        SECURE ‚Ä¢ ANONYMOUS ‚Ä¢ UNTRACEABLE
      </p>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
      <!-- Electronics -->
      <a href="/categories/electronics" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">üíª</div>
          <h3 class="nexus-category-card-title">ELECTRONICS</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>

      <!-- Digital Goods -->
      <a href="/categories/digital" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">üì±</div>
          <h3 class="nexus-category-card-title">DIGITAL GOODS</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>

      <!-- Services -->
      <a href="/categories/services" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">‚öôÔ∏è</div>
          <h3 class="nexus-category-card-title">SERVICES</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>

      <!-- Art & Collectibles -->
      <a href="/categories/art" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">üé®</div>
          <h3 class="nexus-category-card-title">ART & COLLECTIBLES</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>

      <!-- Books & Media -->
      <a href="/categories/books" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">üìö</div>
          <h3 class="nexus-category-card-title">BOOKS & MEDIA</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>

      <!-- Other -->
      <a href="/categories/other" style="text-decoration: none;" hx-boost="true">
        <div class="nexus-category-card">
          <div class="nexus-category-card-icon">üéÅ</div>
          <h3 class="nexus-category-card-title">OTHER</h3>
          <p class="nexus-category-card-count">View listings</p>
        </div>
      </a>
    </div>
  </div>
</section>

{# Featured Listings Section #}
<section id="listings" style="padding: 6rem 0; background: hsla(0, 0%, 15%, 0.3);">
  <div style="max-width: 1400px; margin: 0 auto; padding: 0 1.5rem;">
    <div style="margin-bottom: 4rem; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 2rem;">
      <div>
        <h2 class="nexus-section-title-huge">
          FEATURED LISTINGS
        </h2>
        <p class="nexus-section-subtitle-bold">
          VERIFIED VENDORS ‚Ä¢ ESCROW PROTECTED
        </p>
      </div>
      <a href="/listings" class="nexus-btn nexus-btn-primary nexus-btn-lg" hx-boost="true" style="font-weight: 700;">
        VIEW ALL
      </a>
    </div>

  <div id="listings-results" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    {% if listings and listings | length > 0 %}
      {% for listing in listings %}
      <a href="/listings/{{ listing.id }}" style="text-decoration: none; color: inherit;" hx-boost="true">
        <div class="nexus-card nexus-card-elevated nexus-card-glass nexus-card-hover-lift">
          {% if listing.images_ipfs_cids %}
          <div class="nexus-card-image">
            <img src="/api/listings/{{ listing.id }}/images/{{ listing.images_ipfs_cids | first }}" alt="{{ listing.title }}" loading="lazy">
          </div>
          {% endif %}

          <div class="nexus-card-header">
            <h3 class="nexus-card-title">{{ listing.title }}</h3>
            <p class="nexus-card-subtitle">{{ listing.vendor_username }}</p>
          </div>

          <div class="nexus-card-content">
            <p style="color: var(--nexus-muted-fg, #9ca3af); font-size: 0.875rem; line-height: 1.5; margin-bottom: 1rem;">
              {{ listing.description | truncate(length=100) }}
            </p>

            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-size: 0.75rem; color: var(--nexus-muted-fg, #888); text-transform: uppercase; display: block; margin-bottom: 0.25rem;">Price</span>
                <span style="font-size: 1.25rem; font-weight: 700; color: var(--nexus-primary, #3b82f6); font-family: monospace;">
                  {{ listing.price_xmr }} XMR
                </span>
              </div>
              <div>
                <span class="nexus-badge nexus-badge-{{ listing.status }}">
                  {{ listing.status | upper }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </a>
      {% endfor %}
    {% else %}
      {# Empty State #}
      <div style="grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5rem; text-align: center;">
        <div class="nexus-alert nexus-alert-info">
          <div class="nexus-alert-icon">‚ÑπÔ∏è</div>
          <div class="nexus-alert-content">
            <div class="nexus-alert-title">No listings yet</div>
            <div class="nexus-alert-message">
              Be the first to create a listing on the marketplace!
            </div>
          </div>
        </div>

        {% if logged_in and role == "vendor" %}
        <a href="/listings/create" class="nexus-btn nexus-btn-primary" style="margin-top: 2rem;">
          Create Your First Listing
        </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
  </div>
</section>

{# Stats Banner - TRUE NEXUS STYLE #}
<section class="nexus-stats-banner">
  <div class="nexus-stats-container">
    <div class="nexus-stats-grid">
      <div>
        <div class="nexus-stat-value-large">24/7</div>
        <div class="nexus-stat-label-small">UPTIME</div>
      </div>
      <div>
        <div class="nexus-stat-value-large">0</div>
        <div class="nexus-stat-label-small">LOGS KEPT</div>
      </div>
      <div>
        <div class="nexus-stat-value-large">256</div>
        <div class="nexus-stat-label-small">BIT ENCRYPTION</div>
      </div>
      <div>
        <div class="nexus-stat-value-large">‚àû</div>
        <div class="nexus-stat-label-small">ANONYMITY</div>
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
/**
 * NEXUS Letter Jump Animation Controller
 * Ultra-optimized with mobile support, accessibility, and debouncing
 */
(function() {
  'use strict';

  const ANIMATION_DURATION = 2200; // Must match CSS (2.2s)
  const DEBOUNCE_DELAY = 100; // Prevent spam-clicking

  // Check if user prefers reduced motion
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  // Animation queue to prevent simultaneous jumps
  const animatingLetters = new Set();

  /**
   * Trigger jump animation on a letter
   * @param {HTMLElement} letter - The letter element
   */
  function triggerJump(letter) {
    // Prevent re-triggering if already animating
    if (animatingLetters.has(letter)) {
      return;
    }

    // Respect accessibility preferences
    if (prefersReducedMotion) {
      // Just scale instead of full animation
      letter.style.transform = 'scale(1.2)';
      setTimeout(() => {
        letter.style.transform = '';
      }, 300);
      return;
    }

    // Add to animating set
    animatingLetters.add(letter);

    // Add jumping class
    letter.classList.add('jumping');

    // Remove class after animation completes
    setTimeout(() => {
      letter.classList.remove('jumping');
      animatingLetters.delete(letter);
    }, ANIMATION_DURATION);

    // Optional: Haptic feedback on mobile
    if ('vibrate' in navigator) {
      navigator.vibrate(10); // Subtle vibration
    }
  }

  /**
   * Initialize letter animations with event listeners
   */
  function initLetterAnimations() {
    const letters = document.querySelectorAll('.nexus-animated-letter');

    letters.forEach((letter, index) => {
      // Mouse hover (desktop)
      letter.addEventListener('mouseenter', () => triggerJump(letter));

      // Touch (mobile/tablet)
      letter.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Prevent double-firing with mouseenter
        triggerJump(letter);
      }, { passive: false });

      // Keyboard (accessibility)
      letter.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          triggerJump(letter);
        }
      });

      // Add sequential auto-animation on page load (one time, staggered)
      if (!sessionStorage.getItem('nexus-intro-played')) {
        setTimeout(() => {
          triggerJump(letter);
        }, 500 + (index * 200)); // Stagger by 200ms
      }
    });

    // Mark intro as played (won't replay on navigation)
    if (!sessionStorage.getItem('nexus-intro-played')) {
      setTimeout(() => {
        sessionStorage.setItem('nexus-intro-played', 'true');
      }, 500 + (letters.length * 200) + ANIMATION_DURATION);
    }
  }

  /**
   * Performance: Use Intersection Observer to only animate when visible
   */
  function setupIntersectionObserver() {
    const heroTitle = document.getElementById('nexus-title');
    if (!heroTitle) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          heroTitle.style.opacity = '1';
        }
      });
    }, { threshold: 0.1 });

    observer.observe(heroTitle);
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initLetterAnimations();
      setupIntersectionObserver();
    });
  } else {
    initLetterAnimations();
    setupIntersectionObserver();
  }

  // Optional: Add "Konami code" easter egg (‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA)
  const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
  let konamiIndex = 0;

  document.addEventListener('keydown', (e) => {
    if (e.key === konamiCode[konamiIndex]) {
      konamiIndex++;
      if (konamiIndex === konamiCode.length) {
        // Easter egg: Make ALL letters jump at once
        document.querySelectorAll('.nexus-animated-letter').forEach((letter, i) => {
          setTimeout(() => triggerJump(letter), i * 100);
        });
        konamiIndex = 0;
      }
    } else {
      konamiIndex = 0;
    }
  });

})();
</script>
{% endblock %}
