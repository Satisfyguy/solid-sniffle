{% extends "base.html" %}

{% block title %}My Orders - Monero Marketplace{% endblock %}

{% block content %}
<div class="orders-container">
    <div class="page-header">
        <h1>My Orders</h1>
        <a href="/listings" class="btn btn-secondary">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Browse Listings
        </a>
    </div>

    <!-- Filter Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" data-filter="all">All Orders</button>
            <button class="tab" data-filter="pending">Pending</button>
            <button class="tab" data-filter="funded">Funded</button>
            <button class="tab" data-filter="shipped">Shipped</button>
            <button class="tab" data-filter="completed">Completed</button>
            <button class="tab" data-filter="cancelled">Cancelled</button>
        </div>
    </div>

    <!-- Orders List -->
    <div id="orders-list" class="orders-list">
        {% if orders %}
            {% for order in orders %}
            <div class="card order-card" data-status="{{ order.status }}">
                <div class="order-header">
                    <div class="order-info">
                        <h3 class="order-title">Order #{{ order.id | truncate(length=8, end="") }}</h3>
                        <span class="badge badge-{{ order.status }}">{{ order.status }}</span>
                    </div>
                    <div class="order-meta">
                        <span class="order-date">{{ order.created_at | date(format="%Y-%m-%d %H:%M") }}</span>
                    </div>
                </div>

                <div class="order-body">
                    <div class="order-details">
                        <div class="detail-item">
                            <svg class="detail-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                            <div>
                                <span class="detail-label">Listing</span>
                                <span class="detail-value">{{ order.listing_title }}</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <svg class="detail-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                            </svg>
                            <div>
                                <span class="detail-label">Quantity</span>
                                <span class="detail-value">{{ order.quantity }} units</span>
                            </div>
                        </div>

                        <div class="detail-item">
                            <svg class="detail-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <div>
                                <span class="detail-label">Total Amount</span>
                                <span class="detail-value price">{{ order.total_price_xmr }} XMR</span>
                            </div>
                        </div>

                        {% if role == "buyer" %}
                        <div class="detail-item">
                            <svg class="detail-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <div>
                                <span class="detail-label">Vendor</span>
                                <span class="detail-value">{{ order.vendor_username }}</span>
                            </div>
                        </div>
                        {% elif role == "vendor" %}
                        <div class="detail-item">
                            <svg class="detail-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            <div>
                                <span class="detail-label">Buyer</span>
                                <span class="detail-value">{{ order.buyer_username }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quick Actions -->
                    <div class="order-actions">
                        <a href="/orders/{{ order.id }}" class="btn btn-primary">View Details</a>

                        {% if order.escrow_id %}
                        <a href="/escrow/{{ order.escrow_id }}" class="btn btn-secondary">View Escrow</a>
                        {% endif %}

                        {% if role == "vendor" and order.status == "funded" %}
                        <button
                            class="btn btn-success"
                            hx-post="/api/orders/{{ order.id }}/ship"
                            hx-target="#order-result-{{ order.id }}"
                            hx-swap="innerHTML"
                            hx-confirm="Mark this order as shipped?"
                        >
                            Mark as Shipped
                        </button>
                        {% endif %}

                        {% if role == "buyer" and order.status == "shipped" %}
                        <button
                            class="btn btn-success"
                            hx-post="/api/orders/{{ order.id }}/complete"
                            hx-target="#order-result-{{ order.id }}"
                            hx-swap="innerHTML"
                            hx-confirm="Confirm you received the order?"
                        >
                            Confirm Receipt
                        </button>
                        {% endif %}
                    </div>

                    <div id="order-result-{{ order.id }}"></div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <svg class="empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                <p class="empty-message">No orders yet.</p>
                <a href="/listings" class="btn btn-primary">Browse Listings</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Tab filtering
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.tab');
    const orders = document.querySelectorAll('.order-card');

    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Filter orders
            const filter = this.dataset.filter;
            orders.forEach(order => {
                if (filter === 'all' || order.dataset.status === filter) {
                    order.style.display = 'block';
                } else {
                    order.style.display = 'none';
                }
            });
        });
    });
});
</script>
{% endblock %}
