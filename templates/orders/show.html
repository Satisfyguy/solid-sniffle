{% extends "base-nexus.html" %}

{% block title %}Order #{{ order.id }} ‚Äî NEXUS{% endblock %}

{% block content %}

{# Breadcrumb #}
<section style="max-width: 1400px; margin: 0 auto; padding: var(--nexus-space-6) var(--nexus-space-6) 0;">
  {% include "partials/nexus/molecules/breadcrumb.html" with
     items=[
       {"text": "Home", "href": "/", "icon": "üè†"},
       {"text": "Orders", "href": "/orders"},
       {"text": "Order #" ~ order.id}
     ]
  %}
</section>

{# Main Content #}
<section style="max-width: 1400px; margin: 0 auto; padding: var(--nexus-space-6);">
  <div style="display: grid; grid-template-columns: 1fr 400px; gap: var(--nexus-space-8);">

    {# Left Column - Order Details & Timeline #}
    <div style="display: flex; flex-direction: column; gap: var(--nexus-space-6);">

      {# Order Header #}
      {% include "partials/nexus/molecules/card.html" with
         variant="elevated"
         glassmorphism=true
         content='
           <div style="display: flex; justify-content: space-between; align-items: start;">
             <div>
               <h1 style="font-size: var(--nexus-text-2xl); font-weight: var(--nexus-weight-bold); color: var(--nexus-fg); margin: 0 0 var(--nexus-space-2) 0; font-family: var(--nexus-font-mono);">
                 Order #' ~ order.id ~ '
               </h1>
               <div style="font-size: var(--nexus-text-sm); color: var(--nexus-muted-fg);">
                 Created: ' ~ order.created_at | date(format="%Y-%m-%d %H:%M UTC") ~ '
               </div>
             </div>
             ' ~ include("partials/nexus/atoms/badge.html", with={"text": order.status, "variant": "status-" ~ order.status}) ~ '
           </div>
         '
      %}

      {# Order Timeline #}
      {% if timeline_events %}
      {% include "partials/nexus/organisms/order-timeline.html" with
         order_id=order.id
         current_status=order.status
         events=timeline_events
      %}
      {% endif %}

      {# Escrow Visualizer #}
      {% if order.escrow_id %}
      {% include "partials/nexus/organisms/escrow-visualizer.html" with
         escrow_id=order.escrow_id
         buyer_name="You"
         vendor_name=vendor.username | default(value="Vendor")
         arbiter_name="System Arbiter"
         status=order.status
         amount_xmr=order.total_xmr
      %}
      {% endif %}
    </div>

    {# Right Column - Order Info & Actions #}
    <div style="position: sticky; top: var(--nexus-space-6); align-self: start; display: flex; flex-direction: column; gap: var(--nexus-space-6);">

      {# Order Summary #}
      {% include "partials/nexus/molecules/card.html" with
         title="Order Summary"
         variant="elevated"
         glassmorphism=true
         content='
           <div style="display: flex; flex-direction: column; gap: var(--nexus-space-4);">
             <div>
               <span style="display: block; font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg); text-transform: uppercase; margin-bottom: var(--nexus-space-1);">Listing</span>
               <a href="/listings/' ~ order.listing_id ~ '" style="font-size: var(--nexus-text-sm); color: var(--nexus-primary); text-decoration: none; font-weight: var(--nexus-weight-medium);">
                 ' ~ (order.listing_title | default(value="View Listing")) ~ ' ‚Üí
               </a>
             </div>

             <div>
               <span style="display: block; font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg); text-transform: uppercase; margin-bottom: var(--nexus-space-1);">Total Amount</span>
               <div style="font-size: var(--nexus-text-2xl); font-weight: var(--nexus-weight-black); background: linear-gradient(135deg, var(--nexus-primary) 0%, var(--nexus-accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: var(--nexus-font-mono);">
                 ' ~ (order.total_xmr / 1000000000000) | round(precision=12) ~ ' XMR
               </div>
             </div>

             {% if order.escrow_id %}
             <div>
               <span style="display: block; font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg); text-transform: uppercase; margin-bottom: var(--nexus-space-1);">Escrow ID</span>
               <code style="font-size: var(--nexus-text-xs); color: var(--nexus-fg); background: var(--nexus-muted); padding: var(--nexus-space-1) var(--nexus-space-2); border-radius: var(--nexus-radius-sm); display: block; word-break: break-all;">
                 ' ~ order.escrow_id ~ '
               </code>
             </div>
             {% endif %}
           </div>
         '
      %}

      {# Order Actions #}
      <div style="display: flex; flex-direction: column; gap: var(--nexus-space-3);">
        {% if order.status == "pending" and role == "buyer" %}
          {# Fund Escrow Button #}
          {% include "partials/nexus/atoms/button.html" with
             text="Fund Escrow"
             variant="primary"
             size="lg"
             hx_post="/api/orders/" ~ order.id ~ "/fund"
             class="w-full"
          %}

        {% elif order.status == "funded" and role == "vendor" %}
          {# Mark as Shipped Button #}
          {% include "partials/nexus/atoms/button.html" with
             text="Mark as Shipped"
             variant="primary"
             size="lg"
             hx_post="/api/orders/" ~ order.id ~ "/ship"
             class="w-full"
          %}

        {% elif order.status == "shipped" and role == "buyer" %}
          {# Confirm Receipt Button #}
          {% include "partials/nexus/atoms/button.html" with
             text="Confirm Receipt"
             variant="primary"
             size="lg"
             hx_post="/api/orders/" ~ order.id ~ "/complete"
             class="w-full"
          %}
        {% endif %}

        {# Dispute Button (if applicable) #}
        {% if order.status in ["funded", "shipped"] %}
          {% include "partials/nexus/atoms/button.html" with
             text="Open Dispute"
             variant="destructive"
             size="md"
             hx_post="/api/orders/" ~ order.id ~ "/dispute"
             class="w-full"
          %}
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block scripts %}
<script>
// Handle HTMX responses
document.body.addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.successful) {
    // Reload page to show updated status
    window.location.reload();
  } else {
    alert('Action failed. Please try again.');
  }
});
</script>
{% endblock %}
