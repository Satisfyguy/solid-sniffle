{#
  LISTING FORM PARTIAL

  Usage:
    {% include "partials/listing-form.html" with
       mode="create"
       listing=listing
       csrf_token=csrf_token
    %}

  Parameters:
    - mode: "create" or "edit"
    - listing: listing object (for edit mode)
    - csrf_token: CSRF token
#}

<form id="{{ mode }}-listing-form" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

  {# Title Field #}
  {% include "partials/nexus/atoms/input.html" with
     label="Title"
     type="text"
     id="title"
     name="title"
     placeholder="Product title"
     value=listing.title if mode == "edit" else ""
     required=true
     minlength="3"
     maxlength="200"
     help_text="3-200 characters"
  %}

  {# Description Field #}
  {% include "partials/nexus/atoms/textarea.html" with
     label="Description"
     id="description"
     name="description"
     placeholder="Describe your product in detail..."
     value=listing.description if mode == "edit" else ""
     rows="8"
     required=true
     minlength="10"
     maxlength="5000"
     help_text="10-5000 characters"
     show_count=true
  %}

  {# Price Field #}
  {% include "partials/nexus/atoms/input.html" with
     label="Price (Atomic Units)"
     type="number"
     id="price_xmr"
     name="price_xmr"
     placeholder="0"
     value=listing.price_xmr if mode == "edit" else ""
     min="1"
     required=true
     help_text="1 XMR = 1,000,000,000,000 atomic units (piconeros)"
  %}

  {# XMR Converter Helper #}
  <div style="margin-bottom: var(--nexus-space-6); padding: var(--nexus-space-4); background: rgba(0, 180, 216, 0.1); border: 1px solid rgba(0, 180, 216, 0.3); border-radius: var(--nexus-radius-md);">
    <div style="display: flex; gap: var(--nexus-space-4); align-items: center;">
      <div style="flex: 1;">
        <label for="xmr-helper" style="display: block; font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg); margin-bottom: var(--nexus-space-2); text-transform: uppercase; letter-spacing: var(--nexus-tracking-wide);">
          Quick Convert (XMR)
        </label>
        <input
          type="number"
          id="xmr-helper"
          placeholder="0.000000000000"
          step="0.000000000001"
          min="0"
          style="width: 100%; padding: var(--nexus-space-2); background: var(--nexus-input); border: 1px solid var(--nexus-border); border-radius: var(--nexus-radius-sm); color: var(--nexus-fg); font-family: var(--nexus-font-mono);"
        >
      </div>
      <div style="padding: var(--nexus-space-2); color: var(--nexus-muted-fg);">⇄</div>
      <div style="flex: 1;">
        <label style="display: block; font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg); margin-bottom: var(--nexus-space-2); text-transform: uppercase; letter-spacing: var(--nexus-tracking-wide);">
          Atomic Units
        </label>
        <input
          type="text"
          id="atomic-display"
          readonly
          placeholder="0"
          style="width: 100%; padding: var(--nexus-space-2); background: var(--nexus-muted); border: 1px solid var(--nexus-border); border-radius: var(--nexus-radius-sm); color: var(--nexus-fg); font-family: var(--nexus-font-mono);"
        >
      </div>
    </div>
  </div>

  {# Stock Field #}
  {% include "partials/nexus/atoms/input.html" with
     label="Stock"
     type="number"
     id="stock"
     name="stock"
     placeholder="0"
     value=listing.stock if mode == "edit" else ""
     min="0"
     required=true
     help_text="Available quantity"
  %}

  {# Images Field #}
  <div style="margin-bottom: var(--nexus-space-6);">
    {% include "partials/nexus/atoms/label.html" with
       for="images"
       text="Product Images"
    %}
    <input
      type="file"
      id="images"
      name="images"
      accept="image/jpeg,image/png,image/gif,image/webp"
      multiple
      style="width: 100%; padding: var(--nexus-space-3); background: var(--nexus-input); border: 1px solid var(--nexus-border); border-radius: var(--nexus-radius-sm); color: var(--nexus-fg); cursor: pointer;"
    >
    <small style="display: block; margin-top: var(--nexus-space-2); font-size: var(--nexus-text-xs); color: var(--nexus-muted-fg);">
      Upload 1-10 images (JPEG, PNG, GIF, WebP) - Max 5MB each
    </small>

    {# Image Preview Grid #}
    <div id="image-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--nexus-space-3); margin-top: var(--nexus-space-4);"></div>
  </div>

  {# Existing Images (Edit Mode) #}
  {% if mode == "edit" and images and images | length > 0 %}
  <div style="margin-bottom: var(--nexus-space-6);">
    <h3 style="font-size: var(--nexus-text-sm); font-weight: var(--nexus-weight-bold); color: var(--nexus-fg); margin-bottom: var(--nexus-space-3); text-transform: uppercase; letter-spacing: var(--nexus-tracking-wide);">
      Current Images
    </h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--nexus-space-3);">
      {% for image_cid in images %}
      <div style="position: relative; border-radius: var(--nexus-radius-md); overflow: hidden; border: 1px solid var(--nexus-border);">
        <img
          src="/api/listings/{{ listing.id }}/images/{{ image_cid }}"
          alt="Product image"
          style="width: 100%; height: 120px; object-fit: cover;"
        >
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# Form Actions #}
  <div style="display: flex; gap: var(--nexus-space-4); margin-top: var(--nexus-space-8);">
    {% include "partials/nexus/atoms/button.html" with
       text="Cancel"
       href="/listings"
       variant="ghost"
       size="lg"
       class="flex-1"
    %}

    {% include "partials/nexus/atoms/button.html" with
       text=("Update Listing →" if mode == "edit" else "Create Listing →")
       type="submit"
       variant="primary"
       size="lg"
       class="flex-1"
    %}
  </div>
</form>

<div id="listing-result" style="margin-top: var(--nexus-space-6);"></div>

<script>
// XMR to Atomic Units converter
document.addEventListener('DOMContentLoaded', function() {
  const xmrInput = document.getElementById('xmr-helper');
  const atomicDisplay = document.getElementById('atomic-display');
  const atomicInput = document.getElementById('price_xmr');

  if (xmrInput && atomicDisplay && atomicInput) {
    // XMR → Atomic
    xmrInput.addEventListener('input', function() {
      const xmr = parseFloat(this.value) || 0;
      const atomic = Math.floor(xmr * 1000000000000);
      atomicDisplay.value = atomic.toLocaleString();
      atomicInput.value = atomic;
    });

    // Atomic → XMR (on page load if editing)
    if (atomicInput.value) {
      const atomic = parseFloat(atomicInput.value) || 0;
      const xmr = atomic / 1000000000000;
      xmrInput.value = xmr.toFixed(12);
      atomicDisplay.value = atomic.toLocaleString();
    }
  }

  // Image preview
  const imageInput = document.getElementById('images');
  const previewContainer = document.getElementById('image-preview');

  if (imageInput && previewContainer) {
    imageInput.addEventListener('change', function(e) {
      previewContainer.innerHTML = '';
      const files = e.target.files;

      if (files.length > 10) {
        alert('Maximum 10 images allowed');
        this.value = '';
        return;
      }

      Array.from(files).forEach((file, index) => {
        if (file.size > 5 * 1024 * 1024) {
          alert(`Image ${index + 1} exceeds 5MB limit`);
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.createElement('div');
          preview.style.cssText = `
            position: relative;
            border-radius: var(--nexus-radius-md);
            overflow: hidden;
            border: 1px solid var(--nexus-border);
          `;
          preview.innerHTML = `
            <img src="${e.target.result}" style="width: 100%; height: 120px; object-fit: cover;">
            <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: var(--nexus-space-1); background: rgba(0,0,0,0.7); font-size: var(--nexus-text-xs); color: var(--nexus-fg); text-align: center;">
              ${file.name}
            </div>
          `;
          previewContainer.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });
    });
  }
});
</script>
