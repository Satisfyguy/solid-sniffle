{% extends "base-marketplace.html" %}

{% block title %}Search - NEXUS{% endblock %}

{% block content %}

<div class="container px-4 md:px-8 py-8">
    <!-- Search Bar -->
    <div class="max-w-3xl mx-auto mb-8 space-y-4">
        <form hx-get="/search" hx-trigger="input changed delay:500ms from:#search-input, submit" hx-target="#search-results" hx-push-url="true">
            <div class="relative">
                <svg class="absolute left-4 top-1/2 h-5 w-5 text-muted-foreground" style="transform: translateY(-50%);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.3-4.3"/>
                </svg>
                <input
                    id="search-input"
                    name="q"
                    type="text"
                    value="{{ query | default(value='') }}"
                    placeholder="Search for products, categories, vendors..."
                    class="pl-12 pr-12 text-lg flex h-14 w-full rounded-md border border-input bg-background px-3 py-2 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                />
                {% if query %}
                <button
                    type="button"
                    onclick="document.getElementById('search-input').value=''; this.form.requestSubmit();"
                    class="absolute right-4 top-1/2 text-muted-foreground hover:text-foreground"
                    style="transform: translateY(-50%);"
                >
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
                {% endif %}
            </div>

            <!-- Hidden filter inputs -->
            <input type="hidden" name="category" id="filter-category" value="{{ category | default(value='all') }}">
            <input type="hidden" name="price_range" id="filter-price" value="{{ price_range | default(value='all') }}">
            <input type="hidden" name="sort" id="filter-sort" value="{{ sort | default(value='relevance') }}">
        </form>

        <div class="flex items-center justify-between">
            <p class="text-muted-foreground">
                Found <span class="font-semibold text-foreground">{{ results_count | default(value=0) }}</span> results
            </p>
            <button
                id="filters-toggle"
                class="btn btn-outline gap-2"
                onclick="document.getElementById('filters-card').classList.toggle('hidden')"
            >
                <svg class="lucide-sm" viewBox="0 0 24 24">
                    <line x1="4" x2="4" y1="21" y2="14"/>
                    <line x1="4" x2="4" y1="10" y2="3"/>
                    <line x1="12" x2="12" y1="21" y2="12"/>
                    <line x1="12" x2="12" y1="8" y2="3"/>
                    <line x1="20" x2="20" y1="21" y2="16"/>
                    <line x1="20" x2="20" y1="12" y2="3"/>
                    <line x1="2" x2="6" y1="14" y2="14"/>
                    <line x1="10" x2="14" y1="8" y2="8"/>
                    <line x1="18" x2="22" y1="16" y2="16"/>
                </svg>
                Filters
            </button>
        </div>
    </div>

    <!-- Filters Card -->
    <div id="filters-card" class="card max-w-3xl mx-auto mb-8 animate-slide-up hidden">
        <div class="p-6">
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Category Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Category</label>
                    <select
                        onchange="document.getElementById('filter-category').value = this.value; document.getElementById('search-input').form.requestSubmit();"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                    >
                        <option value="all" {% if category == 'all' %}selected{% endif %}>All Categories</option>
                        <option value="audio" {% if category == 'audio' %}selected{% endif %}>Audio</option>
                        <option value="wearables" {% if category == 'wearables' %}selected{% endif %}>Wearables</option>
                        <option value="devices" {% if category == 'devices' %}selected{% endif %}>Devices</option>
                        <option value="gaming" {% if category == 'gaming' %}selected{% endif %}>Gaming</option>
                    </select>
                </div>

                <!-- Price Range Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Price Range (XMR)</label>
                    <select
                        onchange="document.getElementById('filter-price').value = this.value; document.getElementById('search-input').form.requestSubmit();"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                    >
                        <option value="all" {% if price_range == 'all' %}selected{% endif %}>All Prices</option>
                        <option value="0-0.5" {% if price_range == '0-0.5' %}selected{% endif %}>0 - 0.5 XMR</option>
                        <option value="0.5-1" {% if price_range == '0.5-1' %}selected{% endif %}>0.5 - 1 XMR</option>
                        <option value="1-2" {% if price_range == '1-2' %}selected{% endif %}>1 - 2 XMR</option>
                        <option value="2+" {% if price_range == '2+' %}selected{% endif %}>2+ XMR</option>
                    </select>
                </div>

                <!-- Sort Filter -->
                <div class="space-y-2">
                    <label class="text-sm font-medium">Sort By</label>
                    <select
                        onchange="document.getElementById('filter-sort').value = this.value; document.getElementById('search-input').form.requestSubmit();"
                        class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
                    >
                        <option value="relevance" {% if sort == 'relevance' %}selected{% endif %}>Relevance</option>
                        <option value="price-low" {% if sort == 'price-low' %}selected{% endif %}>Price: Low to High</option>
                        <option value="price-high" {% if sort == 'price-high' %}selected{% endif %}>Price: High to Low</option>
                        <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
                    </select>
                </div>
            </div>

            <div style="height: 1px; background-color: hsl(var(--border)); margin: 1.5rem 0;"></div>

            <!-- Active Filters -->
            <div class="flex items-center justify-between">
                <div class="flex gap-2">
                    {% if category != 'all' %}
                    <button
                        onclick="document.getElementById('filter-category').value='all'; document.getElementById('search-input').form.requestSubmit();"
                        class="btn btn-sm gap-2"
                        style="background-color: hsl(var(--muted));"
                    >
                        Category: {{ category }}
                        <svg class="lucide-sm" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    {% endif %}
                    {% if price_range != 'all' %}
                    <button
                        onclick="document.getElementById('filter-price').value='all'; document.getElementById('search-input').form.requestSubmit();"
                        class="btn btn-sm gap-2"
                        style="background-color: hsl(var(--muted));"
                    >
                        Price: {{ price_range }}
                        <svg class="lucide-sm" viewBox="0 0 24 24" style="width: 0.75rem; height: 0.75rem;">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                {% if category != 'all' or price_range != 'all' %}
                <button
                    onclick="document.getElementById('filter-category').value='all'; document.getElementById('filter-price').value='all'; document.getElementById('search-input').form.requestSubmit();"
                    class="btn btn-ghost btn-sm"
                >
                    Clear All
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div id="search-results">
        {% if results and results | length > 0 %}
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for product in results %}
            <a href="/listings/{{ product.id }}" class="product-card" hx-boost="true">
                <div class="product-card-image">
                    {% if product.first_image_cid %}
                        <img src="http://127.0.0.1:8081/ipfs/{{ product.first_image_cid }}" alt="{{ product.title }}">
                    {% else %}
                        <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #E0E0E0, #BDBDBD); display: flex; align-items: center; justify-content: center; font-size: 4rem; color: #757575;">?</div>
                    {% endif %}
                </div>
                <div class="product-card-content">
                    <p class="product-card-category">{{ product.category | default(value="General") }}</p>
                    <h3 class="product-card-title">{{ product.title }}</h3>
                    <div class="product-card-footer">
                        <div class="product-card-price">
                            <span class="product-card-price-value">{{ product.price_xmr }}</span>
                            <span class="product-card-price-currency">XMR</span>
                        </div>
                        <button class="btn btn-sm btn-accent">
                            <svg class="lucide-sm" viewBox="0 0 24 24">
                                <circle cx="8" cy="21" r="1"/>
                                <circle cx="19" cy="21" r="1"/>
                                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
                            </svg>
                            View
                        </button>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="h-24 w-24 rounded-full flex items-center justify-center mx-auto mb-6" style="background-color: hsl(var(--muted));">
                <svg class="lucide" viewBox="0 0 24 24" style="width: 3rem; height: 3rem; color: hsl(var(--muted-foreground));">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.3-4.3"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold mb-2">No Results Found</h2>
            <p class="text-muted-foreground mb-8">Try adjusting your search or filters</p>
            <button onclick="document.getElementById('search-input').value=''; document.getElementById('search-input').form.requestSubmit();" class="btn btn-primary">
                Clear Search
            </button>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}
