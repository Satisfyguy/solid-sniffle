{% extends "base-nexus.html" %}
{% import "partials/nexus-macros.html" as nx %}

{% block title %}LOGIN — NEXUS{% endblock %}

{% block content %}

{# Animated Background Orbs #}
<div class="nexus-hero-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;">
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-1"></div>
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-2"></div>
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-3"></div>
</div>

{# Auth Container #}
<div style="position: relative; z-index: 1; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;">
  <div class="nexus-card nexus-card-elevated nexus-card-glass" style="max-width: 480px; width: 100%;">
    <div class="nexus-card-header" style="text-align: center; border-bottom: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); padding-bottom: 1.5rem; margin-bottom: 2rem;">
      <h1 style="font-size: 2rem; font-weight: 700; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.1em; margin: 0;">
        LOGIN
      </h1>
      <p style="margin-top: 0.5rem; color: var(--nexus-muted-fg, #9ca3af); font-size: 0.875rem;">
        Access your secure marketplace account
      </p>
    </div>

    <div class="nexus-card-content">
      <form
        hx-post="/api/auth/login"
        hx-target="#auth-result"
        hx-swap="innerHTML"
        hx-indicator=".htmx-indicator"
        hx-disabled-elt="find button[type='submit']"
        role="form"
        aria-label="Login form"
        style="display: flex; flex-direction: column; gap: 1.5rem;"
      >
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" aria-hidden="true">

        <!-- Username Field -->
        <div>
          <label for="username" class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.05em;">
            Username
          </label>
          <input
            type="text"
            id="username"
            name="username"
            placeholder="Your identifier"
            required
            minlength="3"
            autocomplete="username"
            aria-label="Enter your username"
            aria-required="true"
            class="nexus-input"
            style="width: 100%;"
          >
        </div>

        <!-- Password Field -->
        <div>
          <label for="password" class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.05em;">
            Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="••••••••"
            required
            minlength="8"
            autocomplete="current-password"
            aria-label="Enter your password"
            aria-required="true"
            class="nexus-input"
            style="width: 100%;"
          >
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="nexus-btn nexus-btn-primary nexus-btn-lg"
          style="width: 100%; margin-top: 0.5rem;"
          aria-label="Submit login form"
        >
          LOGIN <span class="htmx-indicator" aria-hidden="true" style="margin-left: 0.5rem;">→</span>
        </button>
      </form>

      <!-- Response Container -->
      <div id="auth-result" style="margin-top: 1.5rem;"></div>

      <!-- Register Link -->
      <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); text-align: center;">
        <p style="color: var(--nexus-muted-fg, #9ca3af); font-size: 0.875rem; margin: 0;">
          No account?
          <a
            href="/register"
            hx-boost="true"
            style="color: var(--nexus-primary, #ff1a5c); text-decoration: none; font-weight: 600; margin-left: 0.25rem; transition: all 0.2s ease;"
            onmouseover="this.style.textShadow='0 0 10px var(--nexus-primary)'"
            onmouseout="this.style.textShadow='none'"
          >
            Register Here
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Notification System for Auth Feedback -->
<script src="/static/js/notifications-nexus.js"></script>

<script>
// Handle HTMX response with premium toast notifications
document.body.addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.pathInfo.requestPath === '/api/auth/login') {
    const resultDiv = document.getElementById('auth-result');

    if (event.detail.successful) {
      // Success - show toast and redirect
      if (window.notificationManager) {
        window.notificationManager.showToast(
          '✅ Login Successful',
          'Welcome back! Redirecting to marketplace...',
          'success',
          3000
        );
      }

      resultDiv.innerHTML = `
        <div class="nexus-alert nexus-alert-success" style="padding: 1rem; border-radius: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: hsl(142, 76%, 60%); display: flex; align-items: center; gap: 0.75rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <div>
            <strong style="display: block; margin-bottom: 0.25rem;">Login Successful</strong>
            <small>Redirecting to marketplace...</small>
          </div>
        </div>
      `;

      // Redirect after 2 seconds (HTMX handles this via HX-Redirect header)
      setTimeout(() => {
        if (!window.location.pathname.includes('/login')) {
          // Already redirected by HTMX
          return;
        }
        window.location.href = '/';
      }, 2000);
    } else {
      // Error handling with toast
      const errorMessage = event.detail.xhr?.responseText || 'Invalid username or password';

      if (window.notificationManager) {
        window.notificationManager.showToast(
          '❌ Login Failed',
          errorMessage,
          'error',
          5000
        );
      }

      resultDiv.innerHTML = `
        <div class="nexus-alert nexus-alert-error" style="padding: 1rem; border-radius: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: hsl(0, 85%, 70%); display: flex; align-items: center; gap: 0.75rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <div>
            <strong style="display: block; margin-bottom: 0.25rem;">Login Failed</strong>
            <small>${errorMessage}</small>
          </div>
        </div>
      `;
    }
  }
});
</script>
{% endblock %}
