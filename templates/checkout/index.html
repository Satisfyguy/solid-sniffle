<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Nexus Marketplace</title>
    <meta name="description" content="Finalisez votre commande avec protection escrow multisig 2/3 Monero">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/main.css">
</head>
<body>
    {% include "header.html" %}

    <main class="checkout-container">
        <!-- Back Button -->
        <a href="/cart" class="back-button">
            <i data-lucide="arrow-left"></i>
            <span>Retour au panier</span>
        </a>

        <div class="checkout-wrapper">
            <!-- Header -->
            <div class="checkout-header">
                <h1 class="checkout-title">
                    Checkout <span class="checkout-title-accent">Sécurisé</span>
                </h1>
                <p class="checkout-subtitle">
                    Transaction non-custodial avec escrow multisig 2/3 Monero
                </p>
            </div>

            <!-- Hidden Data for JavaScript -->
            <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
            {% if order %}
            <input type="hidden" id="order-id" value="{{ order.id }}">
            {% endif %}
            {% if escrow %}
            <input type="hidden" id="escrow-id" value="{{ escrow.id }}">
            <input type="hidden" id="escrow-status" value="{{ escrow.status }}">
            {% endif %}
            <input type="hidden" id="checkout-mode" value="{{ checkout_mode | default(value='cart') }}">

            <div class="checkout-grid">
                <!-- Main Form -->
                <div class="checkout-main">
                    <!-- Step 0: Shipping Address (buyer only) -->
                    <div class="checkout-card" id="shipping-address-form" style="{% if escrow_exists %}display:none;{% endif %}">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="map-pin" class="inline-icon"></i>
                                Adresse de Livraison
                            </h2>
                            <p class="checkout-card-description">
                                Saisissez l'adresse où vous souhaitez recevoir votre commande
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <form id="shipping-form" class="shipping-form">
                                <div class="form-group">
                                    <label for="street-address" class="checkout-label">
                                        <i data-lucide="home" class="inline-icon-sm"></i>
                                        Adresse complète
                                    </label>
                                    <input
                                        type="text"
                                        id="street-address"
                                        name="street_address"
                                        class="checkout-input"
                                        placeholder="123 Rue Exemple"
                                        required>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city" class="checkout-label">
                                            Ville
                                        </label>
                                        <input
                                            type="text"
                                            id="city"
                                            name="city"
                                            class="checkout-input"
                                            placeholder="Paris"
                                            required>
                                    </div>

                                    <div class="form-group">
                                        <label for="postal-code" class="checkout-label">
                                            Code postal
                                        </label>
                                        <input
                                            type="text"
                                            id="postal-code"
                                            name="postal_code"
                                            class="checkout-input"
                                            placeholder="75001"
                                            required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="country" class="checkout-label">
                                        <i data-lucide="globe" class="inline-icon-sm"></i>
                                        Pays
                                    </label>
                                    <input
                                        type="text"
                                        id="country"
                                        name="country"
                                        class="checkout-input"
                                        placeholder="France"
                                        required>
                                </div>

                                <div class="form-group">
                                    <label for="shipping-notes" class="checkout-label">
                                        <i data-lucide="message-square" class="inline-icon-sm"></i>
                                        Instructions de livraison (optionnel)
                                    </label>
                                    <textarea
                                        id="shipping-notes"
                                        name="shipping_notes"
                                        class="checkout-input checkout-textarea"
                                        placeholder="Sonnez 3 fois, code d'accès 1234, etc."
                                        rows="3"></textarea>
                                </div>

                                <div class="checkout-notice info">
                                    <i data-lucide="shield" class="checkout-notice-icon"></i>
                                    <div class="checkout-notice-content">
                                        <p class="checkout-notice-title">Confidentialité garantie</p>
                                        <p class="checkout-notice-text">
                                            Votre adresse sera chiffrée (AES-256-GCM) et uniquement visible par le vendeur de cette commande.
                                        </p>
                                    </div>
                                </div>

                                <button type="submit" class="btn-checkout-primary" id="submit-shipping-btn">
                                    <i data-lucide="arrow-right"></i>
                                    <span>Continuer vers le paiement</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Step 1: Escrow Initialization -->
                    <div class="checkout-card" id="escrow-init" style="display:none;">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="lock" class="inline-icon"></i>
                                Initialisation Escrow Multisig
                            </h2>
                            <p class="checkout-card-description">
                                Création du wallet multisig 2/3 (Vous + Vendeur + Arbitre)
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <div class="multisig-progress">
                                <div class="progress-step" id="step-prepare">
                                    <div class="progress-icon">
                                        <i data-lucide="loader"></i>
                                    </div>
                                    <div class="progress-content">
                                        <p class="progress-title">Préparation multisig</p>
                                        <p class="progress-text">Génération des informations multisig...</p>
                                    </div>
                                </div>

                                <div class="progress-step" id="step-make">
                                    <div class="progress-icon">
                                        <i data-lucide="loader"></i>
                                    </div>
                                    <div class="progress-content">
                                        <p class="progress-title">Création wallet partagé</p>
                                        <p class="progress-text">Construction du wallet 2-of-3...</p>
                                    </div>
                                </div>

                                <div class="progress-step" id="step-sync-r1">
                                    <div class="progress-icon">
                                        <i data-lucide="loader"></i>
                                    </div>
                                    <div class="progress-content">
                                        <p class="progress-title">Synchronisation (round 1)</p>
                                        <p class="progress-text">Échange d'informations de sync...</p>
                                    </div>
                                </div>

                                <div class="progress-step" id="step-sync-r2">
                                    <div class="progress-icon">
                                        <i data-lucide="loader"></i>
                                    </div>
                                    <div class="progress-content">
                                        <p class="progress-title">Synchronisation (round 2)</p>
                                        <p class="progress-text">Finalisation du wallet multisig...</p>
                                    </div>
                                </div>

                                <div class="progress-step" id="step-verify">
                                    <div class="progress-icon">
                                        <i data-lucide="loader"></i>
                                    </div>
                                    <div class="progress-content">
                                        <p class="progress-title">Vérification</p>
                                        <p class="progress-text">Contrôle de cohérence du wallet...</p>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout-notice info">
                                <i data-lucide="clock" class="checkout-notice-icon"></i>
                                <div class="checkout-notice-content">
                                    <p class="checkout-notice-text">
                                        Ce processus est automatique et prend généralement 10-30 secondes.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Payment Instructions (once escrow is ready) -->
                    <div class="checkout-card" id="payment-instructions" style="{% if not escrow_exists %}display:none;{% elif escrow.status == 'active' %}display:none;{% endif %}">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="send" class="inline-icon"></i>
                                Envoyer le Paiement
                            </h2>
                            <p class="checkout-card-description">
                                Envoyez le montant exact à l'adresse multisig escrow ci-dessous
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <div class="payment-info-grid">
                                <div class="payment-info-item">
                                    <span class="payment-info-label">Type d'escrow:</span>
                                    <span class="payment-info-value">
                                        <i data-lucide="users" class="inline-icon-sm"></i>
                                        2-of-3 Multisig
                                    </span>
                                </div>
                                <div class="payment-info-item">
                                    <span class="payment-info-label">Participants:</span>
                                    <span class="payment-info-value">Vous + Vendeur + Arbitre</span>
                                </div>
                            </div>

                            <div class="multisig-address-box">
                                <label for="multisig-address" class="checkout-label">
                                    <i data-lucide="lock" class="inline-icon-sm"></i>
                                    Adresse Multisig Escrow
                                </label>
                                <div class="address-input-group">
                                    <input
                                        type="text"
                                        id="multisig-address"
                                        class="checkout-input checkout-input-mono checkout-input-address"
                                        value="{% if escrow and escrow.multisig_address %}{{ escrow.multisig_address }}{% else %}Génération en cours...{% endif %}"
                                        readonly>
                                    <button class="btn-copy" id="copy-address-btn" {% if not escrow or not escrow.multisig_address %}disabled{% endif %}>
                                        <i data-lucide="copy"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="amount-box">
                                <label class="checkout-label">Montant exact à envoyer:</label>
                                <div class="amount-display">
                                    <span class="amount-xmr" id="amount-xmr" data-amount="{% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}">
                                        {% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}
                                    </span>
                                    <span class="amount-currency">XMR</span>
                                </div>
                                <p class="amount-atomic">
                                    (<span id="amount-atomic">{% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}</span> piconeros)
                                </p>
                            </div>

                            <div class="checkout-notice warning">
                                <i data-lucide="alert-triangle" class="checkout-notice-icon"></i>
                                <div class="checkout-notice-content">
                                    <p class="checkout-notice-title">Important</p>
                                    <p class="checkout-notice-text">
                                        Envoyez EXACTEMENT le montant indiqué. Un montant différent retardera le traitement de votre commande.
                                    </p>
                                </div>
                            </div>

                            <div class="security-box">
                                <div class="security-header">
                                    <i data-lucide="shield" class="security-icon"></i>
                                    <h4 class="security-title">Protection Escrow</h4>
                                </div>
                                <ul class="security-list">
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Les fonds sont bloqués dans le wallet multisig
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Libération nécessite 2 signatures sur 3
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Vous + Arbitre = Release vers vendeur
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Vendeur + Arbitre = Refund vers vous
                                    </li>
                                </ul>
                            </div>

                            <div class="payment-status" id="payment-status">
                                <div class="status-icon">
                                    <i data-lucide="clock"></i>
                                </div>
                                <div class="status-content">
                                    <p class="status-title">En attente de paiement</p>
                                    <p class="status-text">Nous surveillons la blockchain...</p>
                                    <div class="status-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="confirmations-progress"></div>
                                        </div>
                                        <p class="progress-label">
                                            <span id="confirmations-count">0</span>/10 confirmations
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Payment Confirmed -->
                    <div class="checkout-card success" id="payment-confirmed" style="{% if not escrow or escrow.status != 'active' %}display:none;{% endif %}">
                        <div class="checkout-card-header">
                            <div class="success-icon-large">
                                <i data-lucide="check-circle"></i>
                            </div>
                            <h2 class="checkout-card-title">Paiement Confirmé!</h2>
                            <p class="checkout-card-description">
                                Votre commande est maintenant en cours de traitement
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <div class="order-next-steps">
                                <h3 class="next-steps-title">Prochaines étapes:</h3>
                                <ol class="next-steps-list">
                                    <li>Le vendeur prépare votre commande</li>
                                    <li>Vous recevrez une notification lors de l'expédition</li>
                                    <li>Confirmez la réception pour libérer les fonds</li>
                                </ol>
                            </div>

                            <div class="order-actions">
                                <a href="{% if order %}/orders/{{ order.id }}{% else %}#{% endif %}" class="btn-checkout-primary">
                                    <i data-lucide="package"></i>
                                    <span>Voir ma commande</span>
                                </a>
                                <a href="/listings" class="btn-checkout-secondary">
                                    <i data-lucide="shopping-bag"></i>
                                    <span>Continuer mes achats</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary Sidebar -->
                <div class="checkout-sidebar">
                    <div class="checkout-summary-card">
                        <div class="checkout-summary-header">
                            <h3 class="checkout-summary-title">Résumé de la commande</h3>
                        </div>
                        <div class="checkout-summary-content">
                            {% if cart %}
                            <!-- Cart Mode -->
                            {% for item in cart.items %}
                            <div class="checkout-summary-item">
                                <div class="checkout-summary-product">
                                    {% if item.image_cid %}
                                    <div class="checkout-summary-image">
                                        <img src="/api/listings/{{ item.listing_id }}/images/{{ item.image_cid }}" alt="{{ item.title }}">
                                    </div>
                                    {% else %}
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    {% endif %}
                                    <div class="checkout-summary-details">
                                        <p class="checkout-summary-name">{{ item.title }}</p>
                                        <p class="checkout-summary-quantity">Quantité: {{ item.quantity }}</p>
                                        <p class="checkout-summary-price" data-price="{{ item.unit_price_xmr }}">
                                            {{ item.unit_price_xmr }} piconeros
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% elif order %}
                            <!-- Order Mode -->
                            <div class="checkout-summary-item">
                                <div class="checkout-summary-product">
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    <div class="checkout-summary-details">
                                        <p class="checkout-summary-name">Commande #{{ order.id | truncate(length=8, end="...") }}</p>
                                        <p class="checkout-summary-quantity">Quantité: 1</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="checkout-summary-breakdown">
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">Sous-total</span>
                                    <span class="checkout-summary-value monero-amount">
                                        {% if cart %}
                                        {{ cart_total_xmr }} XMR
                                        {% elif order %}
                                        {{ order.total_xmr }} piconeros
                                        {% else %}
                                        0 piconeros
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">
                                        Frais escrow
                                        <i data-lucide="help-circle" class="help-icon-sm" title="2% pour protection multisig"></i>
                                    </span>
                                    <span class="checkout-summary-value monero-amount">~0.000200000000 XMR</span>
                                </div>
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">
                                        Frais réseau
                                        <i data-lucide="help-circle" class="help-icon-sm" title="Frais de transaction Monero"></i>
                                    </span>
                                    <span class="checkout-summary-value monero-amount">~0.000100000000 XMR</span>
                                </div>
                                <div class="checkout-summary-total">
                                    <span class="checkout-summary-total-label">Total</span>
                                    <span class="checkout-summary-total-value monero-amount" id="total-xmr">
                                        {% if cart %}
                                        {{ cart_total_xmr }} XMR
                                        {% elif order %}
                                        {{ order.total_xmr }} piconeros
                                        {% else %}
                                        0 piconeros
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="checkout-summary-security">
                                <div class="checkout-security-badge monero">
                                    <img src="/static/img/monero-logo.svg" alt="Monero" class="crypto-logo">
                                    <span>Monero (XMR) uniquement</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="shield" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Escrow multisig 2/3</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="lock" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Non-custodial (vos clés)</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="eye-off" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Anonymat total via Tor</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/static/js/lucide.min.js"></script>
    <script src="/static/js/checkout.js"></script>
    <script src="/static/js/base.js"></script>
</body>
</html>
