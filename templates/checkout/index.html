<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Nexus Marketplace</title>
    <meta name="description" content="Complete your order with 2/3 multisig Monero escrow protection">
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/checkout-stepper.css">
</head>
<body>
    {% include "header.html" %}

    <main class="checkout-container">
        <!-- Back Button -->
        <a href="/cart" class="back-button">
            <i data-lucide="arrow-left"></i>
            <span>Back to Cart</span>
        </a>

        <div class="checkout-wrapper">
            <!-- Header -->
            <div class="checkout-header">
                <div class="checkout-header-content">
                    <h1 class="checkout-title">
                        Secure <span class="checkout-title-accent">Checkout</span>
                    </h1>
                    <div class="checkout-security-features">
                        <div class="security-feature-item">
                            <i data-lucide="shield-check" class="security-feature-icon"></i>
                            <span>Non-custodial</span>
                        </div>
                        <div class="security-feature-divider"></div>
                        <div class="security-feature-item">
                            <i data-lucide="users" class="security-feature-icon"></i>
                            <span>2/3 Multisig</span>
                        </div>
                        <div class="security-feature-divider"></div>
                        <div class="security-feature-item">
                            <i data-lucide="eye-off" class="security-feature-icon"></i>
                            <span>Monero Privacy</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Stepper -->
            <div id="checkout-stepper" class="checkout-stepper">
                <div class="checkout-stepper-step" data-step-id="shipping">
                    <div class="checkout-stepper-step-indicator"><span>1</span></div>
                    <div class="checkout-stepper-step-label">Shipping Info</div>
                </div>
                <div class="checkout-stepper-step" data-step-id="escrow">
                    <div class="checkout-stepper-step-indicator"><span>2</span></div>
                    <div class="checkout-stepper-step-label">Escrow Setup</div>
                </div>
                <div class="checkout-stepper-step" data-step-id="payment">
                    <div class="checkout-stepper-step-indicator"><span>3</span></div>
                    <div class="checkout-stepper-step-label">Payment</div>
                </div>
                <div class="checkout-stepper-step" data-step-id="confirmation">
                    <div class="checkout-stepper-step-indicator"><span>4</span></div>
                    <div class="checkout-stepper-step-label">Confirmation</div>
                </div>
            </div>

            <!-- Hidden Data for JavaScript -->
            <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
            {% if order %}
            <input type="hidden" id="order-id" value="{{ order.id }}">
            {% endif %}
            {% if escrow %}
            <input type="hidden" id="escrow-id" value="{{ escrow.id }}">
            <input type="hidden" id="escrow-status" value="{{ escrow.status }}">
            {% endif %}
            <input type="hidden" id="checkout-mode" value="{{ checkout_mode | default(value='cart') }}">

            <div class="checkout-grid">
                <!-- Main Form -->
                <div class="checkout-main">
                    <!-- Step 0: Shipping Address (buyer only) -->
                    <div class="checkout-card" id="shipping-address-form" data-step-content="shipping">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="map-pin" class="inline-icon"></i>
                                Shipping Address
                            </h2>
                            <p class="checkout-card-description">
                                Enter the address where you want to receive your order
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <form id="shipping-form" class="shipping-form">
                                <div class="form-group">
                                    <label for="street-address" class="checkout-label">
                                        <i data-lucide="home" class="inline-icon-sm"></i>
                                        Full Address
                                    </label>
                                    <input
                                        type="text"
                                        id="street-address"
                                        name="street_address"
                                        class="checkout-input"
                                        placeholder="123 Example Street"
                                        required>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="city" class="checkout-label">
                                            City
                                        </label>
                                        <input
                                            type="text"
                                            id="city"
                                            name="city"
                                            class="checkout-input"
                                            placeholder="New York"
                                            required>
                                    </div>

                                    <div class="form-group">
                                        <label for="postal-code" class="checkout-label">
                                            Postal Code
                                        </label>
                                        <input
                                            type="text"
                                            id="postal-code"
                                            name="postal_code"
                                            class="checkout-input"
                                            placeholder="10001"
                                            required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="country" class="checkout-label">
                                        <i data-lucide="globe" class="inline-icon-sm"></i>
                                        Country
                                    </label>
                                    <input
                                        type="text"
                                        id="country"
                                        name="country"
                                        class="checkout-input"
                                        placeholder="United States"
                                        required>
                                </div>

                                <div class="form-group">
                                    <label for="shipping-notes" class="checkout-label">
                                        <i data-lucide="message-square" class="inline-icon-sm"></i>
                                        Shipping Instructions (optional)
                                    </label>
                                    <textarea
                                        id="shipping-notes"
                                        name="shipping_notes"
                                        class="checkout-input checkout-textarea"
                                        placeholder="Ring 3 times, access code 1234, etc."
                                        rows="3"></textarea>
                                </div>

                                <div class="checkout-notice info">
                                    <i data-lucide="shield" class="checkout-notice-icon"></i>
                                    <div class="checkout-notice-content">
                                        <p class="checkout-notice-title">Privacy Guaranteed</p>
                                        <p class="checkout-notice-text">
                                            Your address is encrypted with AES-256-GCM before storage. Only the vendor can decrypt it.
                                            Database also encrypted (SQLCipher) for defense-in-depth protection.
                                        </p>
                                    </div>
                                </div>

                                <button type="submit" class="btn-checkout-primary" id="submit-shipping-btn">
                                    <i data-lucide="arrow-right"></i>
                                    <span>Continue to Payment</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Step 1: Escrow Initialization -->
                    <div class="checkout-card" id="escrow-init" data-step-content="escrow" style="display:none;">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="lock" class="inline-icon"></i>
                                Multisig Escrow Initialization
                            </h2>
                            <p class="checkout-card-description">
                                Creating 2/3 multisig wallet (You + Vendor + Arbiter)
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <!-- Global Progress Bar -->
                            <div class="multisig-global-progress" style="margin-bottom: 1.5rem;">
                                <!-- Status and Percentage on same line -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <span style="font-weight: 600; font-size: 0.9rem; color: rgba(255,255,255,0.9);" id="progress-status-text">Initializing...</span>
                                    <span style="font-weight: 700; font-size: 1.1rem; color: #C9A445;" id="progress-percentage">0%</span>
                                </div>

                                <!-- Progress Bar -->
                                <div style="width: 100%; height: 12px; background: rgba(201, 164, 69, 0.2); border-radius: 9999px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div id="progress-bar-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #C9A445 0%, #D4AF37 100%); transition: width 0.5s ease-out; border-radius: 9999px;"></div>
                                </div>

                                <!-- Time info on same line -->
                                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; color: rgba(255,255,255,0.5);">
                                    <span id="progress-elapsed">Elapsed: 0s</span>
                                    <span>•</span>
                                    <span id="progress-eta">ETA: ~2 min</span>
                                </div>
                            </div>

                            <!-- Typewriter Effect -->
                            <div style="margin-top: 2rem; margin-left: 0.5rem; min-height: 2rem; display: flex; align-items: center;">
                                <span class="typewriter-text" id="multisig-typewriter" style="font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; font-weight: 400; color: #C9A445; letter-spacing: 0.05em;"></span>
                                <span class="typewriter-cursor" style="font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; color: #C9A445; margin-left: 2px; animation: blink 1s step-end infinite;">|</span>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Payment Instructions (once escrow is ready) -->
                    <div class="checkout-card" id="payment-instructions" data-step-content="payment" style="display:none;">
                        <div class="checkout-card-header">
                            <h2 class="checkout-card-title">
                                <i data-lucide="send" class="inline-icon"></i>
                                Envoyer le Paiement
                            </h2>
                            <p class="checkout-card-description">
                                Envoyez le montant exact à l'adresse multisig escrow ci-dessous
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <div class="payment-info-grid">
                                <div class="payment-info-item">
                                    <span class="payment-info-label">Type d'escrow:</span>
                                    <span class="payment-info-value">
                                        <i data-lucide="users" class="inline-icon-sm"></i>
                                        2-of-3 Multisig
                                    </span>
                                </div>
                                <div class="payment-info-item">
                                    <span class="payment-info-label">Participants:</span>
                                    <span class="payment-info-value">Vous + Vendeur + Arbitre</span>
                                </div>
                            </div>

                            <div class="multisig-address-box">
                                <label for="multisig-address" class="checkout-label">
                                    <i data-lucide="lock" class="inline-icon-sm"></i>
                                    Multisig Escrow Address
                                </label>
                                <div class="address-input-group">
                                    <input
                                        type="text"
                                        id="multisig-address"
                                        class="checkout-input checkout-input-mono checkout-input-address"
                                        value="{% if escrow and escrow.multisig_address %}{{ escrow.multisig_address }}{% else %}Generating address...{% endif %}"
                                        readonly>
                                    <button class="btn-copy" id="copy-address-btn" {% if not escrow or not escrow.multisig_address %}disabled{% endif %}>
                                        <i data-lucide="copy"></i>
                                    </button>
                                </div>

                                <!-- QR Code Display -->
                                <div id="qrcode-container" style="display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; padding: 1.5rem; background: #1a1a2e; border-radius: 0.75rem; border: 2px solid rgba(139, 92, 246, 0.3);">
                                    <div id="qrcode" style="background: white; padding: 1rem; border-radius: 0.5rem;"></div>
                                </div>

                                <!-- NON-CUSTODIAL Educational Banner -->
                                <div class="checkout-notice info" style="margin-top: 1.5rem; background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border-color: rgba(34, 211, 238, 0.4);">
                                    <i data-lucide="shield-check" class="checkout-notice-icon" style="color: #22d3ee;"></i>
                                    <div class="checkout-notice-content">
                                        <p class="checkout-notice-title" style="color: #22d3ee; font-weight: 600;">100% Non-Custodial Architecture</p>
                                        <p class="checkout-notice-text" style="font-size: 0.875rem; line-height: 1.6;">
                                            <strong>Pay from ANY Monero wallet you control.</strong> The server created 3 empty temporary wallets to generate this multisig address - these wallets never hold funds (0 XMR forever). Send payment from your personal Monero CLI, GUI, or mobile wallet directly to the address above. The server NEVER has custody of your funds.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="amount-box">
                                <label class="checkout-label">Montant exact à envoyer:</label>
                                <div class="amount-display">
                                    <span class="amount-xmr" id="amount-xmr" data-amount="{% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}">
                                        {% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}
                                    </span>
                                    <span class="amount-currency">XMR</span>
                                </div>
                                <p class="amount-atomic">
                                    (<span id="amount-atomic">{% if escrow %}{{ escrow.amount }}{% else %}0{% endif %}</span> piconeros)
                                </p>
                            </div>

                            <div class="checkout-notice warning">
                                <i data-lucide="alert-triangle" class="checkout-notice-icon"></i>
                                <div class="checkout-notice-content">
                                    <p class="checkout-notice-title">Important</p>
                                    <p class="checkout-notice-text">
                                        Envoyez EXACTEMENT le montant indiqué. Un montant différent retardera le traitement de votre commande.
                                    </p>
                                </div>
                            </div>

                            <div class="security-box">
                                <div class="security-header">
                                    <i data-lucide="shield" class="security-icon"></i>
                                    <h4 class="security-title">Protection Escrow</h4>
                                </div>
                                <ul class="security-list">
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Les fonds sont bloqués dans le wallet multisig
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Libération nécessite 2 signatures sur 3
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Vous + Arbitre = Release vers vendeur
                                    </li>
                                    <li>
                                        <i data-lucide="check" class="check-icon"></i>
                                        Vendeur + Arbitre = Refund vers vous
                                    </li>
                                </ul>
                            </div>

                            <!-- Fund Escrow Button -->
                            <div class="checkout-action-buttons" style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                                <button type="button" class="btn-checkout-primary" id="fund-escrow-btn">
                                    <i data-lucide="wallet"></i>
                                    <span>J'ai envoyé les fonds - Vérifier le paiement</span>
                                </button>
                                <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); text-align: center; margin: 0;">
                                    Cliquez après avoir envoyé le paiement depuis votre wallet Monero
                                </p>
                            </div>

                            <div class="payment-status" id="payment-status">
                                <div class="status-icon">
                                    <i data-lucide="clock"></i>
                                </div>
                                <div class="status-content">
                                    <p class="status-title">En attente de paiement</p>
                                    <p class="status-text">Nous surveillons la blockchain...</p>
                                    <div class="status-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="confirmations-progress"></div>
                                        </div>
                                        <p class="progress-label">
                                            <span id="confirmations-count">0</span>/10 confirmations
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Payment Confirmed -->
                    <div class="checkout-card success" id="payment-confirmed" data-step-content="confirmation" style="display:none;">
                        <div class="checkout-card-header">
                            <div class="success-icon-large">
                                <i data-lucide="check-circle"></i>
                            </div>
                            <h2 class="checkout-card-title">Paiement Confirmé!</h2>
                            <p class="checkout-card-description">
                                Votre commande est maintenant en cours de traitement
                            </p>
                        </div>
                        <div class="checkout-card-content">
                            <div class="order-next-steps">
                                <h3 class="next-steps-title">Prochaines étapes:</h3>
                                <ol class="next-steps-list">
                                    <li>Le vendeur prépare votre commande</li>
                                    <li>Vous recevrez une notification lors de l'expédition</li>
                                    <li>Confirmez la réception pour libérer les fonds</li>
                                </ol>
                            </div>

                            <div class="order-actions">
                                <a href="{% if order %}/orders/{{ order.id }}{% else %}#{% endif %}" class="btn-checkout-primary">
                                    <i data-lucide="package"></i>
                                    <span>Voir ma commande</span>
                                </a>
                                <a href="/listings" class="btn-checkout-secondary">
                                    <i data-lucide="shopping-bag"></i>
                                    <span>Continuer mes achats</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Summary Sidebar -->
                <div class="checkout-sidebar">
                    <div class="checkout-summary-card">
                        <div class="checkout-summary-header">
                            <h3 class="checkout-summary-title">Order Summary</h3>
                        </div>
                        <div class="checkout-summary-content">
                            {% if listing %}
                            <!-- Listing Mode (Buy Now) -->
                            <div class="checkout-summary-item">
                                <div class="checkout-summary-product">
                                    {% if listing.images_ipfs_cids %}
                                    {% set images = listing.images_ipfs_cids | json_decode %}
                                    {% if images and images | length > 0 %}
                                    <div class="checkout-summary-image">
                                        <img src="/api/listings/{{ listing.id }}/images/{{ images[0] }}" alt="{{ listing.title }}">
                                    </div>
                                    {% else %}
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    {% endif %}
                                    <div class="checkout-summary-details">
                                        <p class="checkout-summary-name">{{ listing.title }}</p>
                                        <p class="checkout-summary-quantity">Quantity: 1</p>
                                        <p class="checkout-summary-price" data-price="{{ listing.price_xmr }}">
                                            {{ listing.price_xmr }} piconeros
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% elif cart %}
                            <!-- Cart Mode -->
                            {% for item in cart.items %}
                            <div class="checkout-summary-item">
                                <div class="checkout-summary-product">
                                    {% if item.image_cid %}
                                    <div class="checkout-summary-image">
                                        <img src="/api/listings/{{ item.listing_id }}/images/{{ item.image_cid }}" alt="{{ item.title }}">
                                    </div>
                                    {% else %}
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    {% endif %}
                                    <div class="checkout-summary-details">
                                        <p class="checkout-summary-name">{{ item.title }}</p>
                                        <p class="checkout-summary-quantity">Quantity: {{ item.quantity }}</p>
                                        <p class="checkout-summary-price" data-price="{{ item.unit_price_xmr }}">
                                            {{ item.unit_price_xmr }} piconeros
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% elif order %}
                            <!-- Order Mode -->
                            <div class="checkout-summary-item">
                                <div class="checkout-summary-product">
                                    <div class="checkout-summary-image checkout-summary-image-placeholder">
                                        <i data-lucide="package"></i>
                                    </div>
                                    <div class="checkout-summary-details">
                                        <p class="checkout-summary-name">Order #{{ order.id | truncate(length=8, end="...") }}</p>
                                        <p class="checkout-summary-quantity">Quantity: 1</p>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="checkout-summary-breakdown">
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">Subtotal</span>
                                    <span class="checkout-summary-value monero-amount">
                                        {% if cart %}
                                        {{ cart_total_xmr }} XMR
                                        {% elif order %}
                                        {{ order.total_xmr }} piconeros
                                        {% else %}
                                        0 piconeros
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">
                                        Escrow Fee
                                        <i data-lucide="help-circle" class="help-icon-sm" title="2% for multisig protection"></i>
                                    </span>
                                    <span class="checkout-summary-value monero-amount">~0.000200000000 XMR</span>
                                </div>
                                <div class="checkout-summary-row">
                                    <span class="checkout-summary-label">
                                        Network Fee
                                        <i data-lucide="help-circle" class="help-icon-sm" title="Monero transaction fee"></i>
                                    </span>
                                    <span class="checkout-summary-value monero-amount">~0.000100000000 XMR</span>
                                </div>
                                <div class="checkout-summary-total">
                                    <span class="checkout-summary-total-label">Total</span>
                                    <span class="checkout-summary-total-value monero-amount" id="total-xmr">
                                        {% if cart %}
                                        {{ cart_total_xmr }} XMR
                                        {% elif order %}
                                        {{ order.total_xmr }} piconeros
                                        {% else %}
                                        0 piconeros
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="checkout-summary-security">
                                <div class="checkout-security-badge monero">
                                    <img src="/static/img/monero-logo.svg" alt="Monero" class="crypto-logo">
                                    <span>Monero (XMR) uniquement</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="shield" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Escrow multisig 2/3</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="lock" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Non-custodial (vos clés)</span>
                                </div>
                                <div class="checkout-security-item">
                                    <i data-lucide="eye-off" class="checkout-security-icon"></i>
                                    <span class="checkout-security-text">Anonymat total via Tor</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="/static/js/lucide.min.js"></script>
    <script src="/static/js/checkout-stepper.js"></script>
    <script src="/static/js/checkout.js"></script>
    <script src="/static/js/checkout-init.js"></script>
    <script src="/static/js/base.js"></script>

    <!-- Typewriter CSS -->
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>

    <!-- Typewriter Script -->
    <!-- Typewriter logic moved to checkout.js to avoid CSP violation -->
</body>
</html>
