{% extends "base-nexus.html" %}
{% import "partials/nexus-macros.html" as nx %}

{% block title %}SETTINGS ‚Äî NEXUS{% endblock %}

{% block content %}

{# Animated Background Orbs #}
<div class="nexus-hero-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;">
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-1"></div>
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-2"></div>
  <div class="nexus-hero-bg-orb nexus-hero-bg-orb-3"></div>
</div>

{# Settings Container #}
<div style="position: relative; z-index: 1; min-height: 100vh; padding: 6rem 2rem 2rem;">
  <div class="container" style="max-width: 800px; margin: 0 auto;">

    {# Page Header #}
    <div style="margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; font-weight: 700; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.1em; margin: 0;">
        ‚öôÔ∏è SETTINGS
      </h1>
      <p style="margin-top: 0.75rem; color: var(--nexus-muted-fg, #9ca3af); font-size: 1rem;">
        Manage your account settings and preferences
      </p>
    </div>

    {# Account Information Card #}
    <div class="nexus-card nexus-card-elevated nexus-card-glass" style="margin-bottom: 2rem;">
      <div class="nexus-card-header" style="border-bottom: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); padding-bottom: 1rem; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
          üë§ ACCOUNT INFORMATION
        </h2>
      </div>

      <div class="nexus-card-content">
        <div style="display: grid; gap: 1rem;">
          <div>
            <label class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--nexus-muted-fg, #9ca3af); text-transform: uppercase; letter-spacing: 0.05em;">
              Username
            </label>
            <div style="padding: 0.75rem 1rem; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); border-radius: 8px; color: var(--nexus-fg, #f9fafb); font-weight: 500;">
              {{ username }}
            </div>
          </div>

          <div>
            <label class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--nexus-muted-fg, #9ca3af); text-transform: uppercase; letter-spacing: 0.05em;">
              Role
            </label>
            <div style="padding: 0.75rem 1rem; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); border-radius: 8px; color: var(--nexus-fg, #f9fafb); font-weight: 500;">
              {% if role == "vendor" %}üè™ Vendor{% else %}üõí Buyer{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# Wallet Configuration Card (Vendors only) #}
    {% if role == "vendor" %}
    <div class="nexus-card nexus-card-elevated nexus-card-glass">
      <div class="nexus-card-header" style="border-bottom: 1px solid var(--nexus-glass-border, rgba(255, 255, 255, 0.1)); padding-bottom: 1rem; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">
          üí∞ MONERO WALLET
        </h2>
        <p style="margin-top: 0.5rem; color: var(--nexus-muted-fg, #9ca3af); font-size: 0.875rem;">
          Configure your Monero address to receive payments from completed orders
        </p>
      </div>

      <div class="nexus-card-content">
        <form
          hx-post="/api/settings/update-wallet"
          hx-target="#wallet-result"
          hx-swap="innerHTML"
          hx-indicator=".htmx-indicator"
          hx-disabled-elt="find button[type='submit']"
          role="form"
          aria-label="Update wallet address form"
          style="display: flex; flex-direction: column; gap: 1.5rem;"
        >
          <!-- CSRF Token -->
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" aria-hidden="true">

          <!-- Current Wallet Address (if set) -->
          {% if wallet_address %}
          <div style="padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px;">
            <label class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: hsl(142, 76%, 60%); text-transform: uppercase; letter-spacing: 0.05em;">
              ‚úÖ Current Wallet Address
            </label>
            <div style="font-family: monospace; font-size: 0.8125rem; color: hsl(142, 76%, 70%); word-break: break-all; line-height: 1.6;">
              {{ wallet_address }}
            </div>
          </div>
          {% else %}
          <div style="padding: 1rem; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 8px; display: flex; align-items: start; gap: 0.75rem;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="hsl(45, 93%, 47%)" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div>
              <strong style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: hsl(45, 93%, 57%);">
                ‚ö†Ô∏è Wallet Address Not Configured
              </strong>
              <small style="color: hsl(45, 93%, 67%); font-size: 0.8125rem;">
                You must configure your Monero wallet address before you can mark orders as shipped and receive payments.
              </small>
            </div>
          </div>
          {% endif %}

          <!-- New Wallet Address Input -->
          <div>
            <label for="wallet_address" class="nexus-label" style="display: block; margin-bottom: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--nexus-fg, #f9fafb); text-transform: uppercase; letter-spacing: 0.05em;">
              {% if wallet_address %}Update Wallet Address{% else %}Wallet Address{% endif %}
              <span style="color: var(--nexus-primary, #ff1a5c);">*</span>
            </label>
            <input
              type="text"
              id="wallet_address"
              name="wallet_address"
              placeholder="4... or 8..."
              required
              minlength="95"
              maxlength="106"
              autocomplete="off"
              aria-label="Your Monero wallet address"
              aria-describedby="wallet-help"
              class="nexus-input"
              style="width: 100%; font-family: monospace; font-size: 0.875rem;"
              value=""
            >
            <small id="wallet-help" style="display: block; margin-top: 0.5rem; font-size: 0.75rem; color: var(--nexus-muted-fg, #9ca3af);">
              Enter a valid Monero address (starts with 4 or 8, 95-106 characters). This is where you'll receive payments for completed orders.
            </small>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="nexus-btn nexus-btn-primary nexus-btn-lg"
            style="width: 100%; margin-top: 0.5rem;"
            aria-label="Update wallet address"
          >
            {% if wallet_address %}UPDATE WALLET ADDRESS{% else %}SAVE WALLET ADDRESS{% endif %}
            <span class="htmx-indicator" aria-hidden="true" style="margin-left: 0.5rem;">‚Üí</span>
          </button>
        </form>

        <!-- Response Container -->
        <div id="wallet-result" style="margin-top: 1.5rem;"></div>
      </div>
    </div>
    {% endif %}

  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Notification System -->
<script src="/static/js/notifications-nexus.js"></script>

<script>
// Handle HTMX response for wallet update
document.body.addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.pathInfo.requestPath === '/api/settings/update-wallet') {
    const resultDiv = document.getElementById('wallet-result');

    if (event.detail.successful) {
      // Success - show toast
      if (window.notificationManager) {
        window.notificationManager.showToast(
          '‚úÖ Wallet Updated',
          'Your Monero wallet address has been saved successfully.',
          'success',
          3000
        );
      }

      resultDiv.innerHTML = `
        <div class="nexus-alert nexus-alert-success" style="padding: 1rem; border-radius: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: hsl(142, 76%, 60%); display: flex; align-items: center; gap: 0.75rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <div>
            <strong style="display: block; margin-bottom: 0.25rem;">Wallet Address Updated</strong>
            <small>Your payment address has been saved. You can now mark orders as shipped.</small>
          </div>
        </div>
      `;

      // Reload page after 2 seconds to show updated address
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      // Error handling with toast
      const errorMessage = event.detail.xhr?.responseText || 'Failed to update wallet address';

      if (window.notificationManager) {
        window.notificationManager.showToast(
          '‚ùå Update Failed',
          errorMessage,
          'error',
          5000
        );
      }

      resultDiv.innerHTML = `
        <div class="nexus-alert nexus-alert-error" style="padding: 1rem; border-radius: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: hsl(0, 85%, 70%); display: flex; align-items: center; gap: 0.75rem;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <div>
            <strong style="display: block; margin-bottom: 0.25rem;">Update Failed</strong>
            <small>${errorMessage}</small>
          </div>
        </div>
      `;
    }
  }
});
</script>
{% endblock %}
