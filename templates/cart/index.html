{% extends "base-marketplace.html" %}

{% block title %}Shopping Cart - NEXUS{% endblock %}

{% block content %}
<div class="section container" style="padding-top: 2rem;">
  <div style="max-width: 1200px; margin: 0 auto;">

    {# Page Header #}
    <div class="section-header" style="margin-bottom: 2rem;">
      <h1 class="section-title">Shopping Cart</h1>
      <p class="section-subtitle">Review your items before checkout</p>
    </div>

    {% if cart and cart.items and cart.items | length > 0 %}
      <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">

        {# Cart Items #}
        <div class="card">
          <div class="card-header" style="border-bottom: 1px solid hsl(var(--border)); padding: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Cart Items ({{ cart.item_count }})</h2>
          </div>

          <div class="card-content" style="padding: 0;">
            {% for item in cart.items %}
            <div class="cart-item" data-listing-id="{{ item.listing_id }}" style="padding: 1.5rem; border-bottom: 1px solid hsl(var(--border)); display: flex; gap: 1.5rem; align-items: start;">

              {# Product Image #}
              <div style="width: 120px; height: 120px; border-radius: 8px; overflow: hidden; background: hsl(var(--muted)); flex-shrink: 0;">
                {% if item.image_cid %}
                  <img src="/api/listings/{{ item.listing_id }}/images/{{ item.image_cid }}"
                       alt="{{ item.title }}"
                       style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                  <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: hsl(var(--muted-foreground));">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21 15 16 10 5 21"/>
                    </svg>
                  </div>
                {% endif %}
              </div>

              {# Product Info #}
              <div style="flex: 1;">
                <a href="/listings/{{ item.listing_id }}" style="font-size: 1.125rem; font-weight: 600; color: hsl(var(--foreground)); text-decoration: none; display: block; margin-bottom: 0.5rem;">
                  {{ item.title }}
                </a>
                <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.75rem;">
                  Sold by <a href="/vendor/{{ item.vendor_id }}" style="color: hsl(var(--primary)); text-decoration: none; font-weight: 500;">{{ item.vendor_username }}</a>
                </p>
                <p style="font-family: monospace; font-size: 1rem; font-weight: 600; color: hsl(var(--foreground)); margin-bottom: 1rem;">
                  {{ item.unit_price_xmr | float / 1000000000000 }} XMR each
                </p>

                {# Quantity Controls #}
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; border: 1px solid hsl(var(--border)); border-radius: 6px; padding: 0.25rem;">
                    <button
                      class="btn btn-ghost btn-sm quantity-decrease"
                      data-listing-id="{{ item.listing_id }}"
                      style="padding: 0.25rem 0.5rem; min-width: 32px;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                    <input
                      type="number"
                      class="quantity-input"
                      data-listing-id="{{ item.listing_id }}"
                      value="{{ item.quantity }}"
                      min="1"
                      style="width: 60px; text-align: center; border: none; background: transparent; font-weight: 600; font-size: 1rem;">
                    <button
                      class="btn btn-ghost btn-sm quantity-increase"
                      data-listing-id="{{ item.listing_id }}"
                      style="padding: 0.25rem 0.5rem; min-width: 32px;">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                  </div>

                  <button
                    class="btn btn-ghost btn-sm remove-item"
                    data-listing-id="{{ item.listing_id }}"
                    style="color: hsl(0, 84%, 60%);">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    Remove
                  </button>
                </div>
              </div>

              {# Item Total #}
              <div style="text-align: right;">
                <p style="font-size: 0.875rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.25rem;">Subtotal</p>
                <p class="item-total" style="font-family: monospace; font-size: 1.25rem; font-weight: 700; color: hsl(var(--foreground));">
                  {{ item.unit_price_xmr * item.quantity | float / 1000000000000 }} XMR
                </p>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        {# Order Summary Card #}
        <div class="card" style="width: 380px; position: sticky; top: 1rem;">
          <div class="card-header" style="border-bottom: 1px solid hsl(var(--border)); padding: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Order Summary</h2>
          </div>

          <div class="card-content" style="padding: 1.5rem;">
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: hsl(var(--muted-foreground));">Items ({{ cart_total_quantity }})</span>
                <span style="font-family: monospace; font-weight: 600;">{{ cart_total_xmr }} XMR</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: hsl(var(--muted-foreground));">Shipping</span>
                <span style="font-family: monospace; font-weight: 600; color: hsl(142, 76%, 36%);">Free</span>
              </div>
              <div style="height: 1px; background: hsl(var(--border)); margin: 1rem 0;"></div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-size: 1.125rem; font-weight: 600;">Total</span>
                <span id="cart-total" style="font-family: monospace; font-size: 1.5rem; font-weight: 700; color: hsl(var(--primary));">{{ cart_total_xmr }} XMR</span>
              </div>
            </div>

            {% if logged_in %}
              <a href="/checkout" class="btn btn-primary btn-lg" style="width: 100%; text-align: center; text-decoration: none; margin-bottom: 0.75rem;">
                Proceed to Checkout
              </a>
            {% else %}
              <a href="/login?redirect=/checkout" class="btn btn-primary btn-lg" style="width: 100%; text-align: center; text-decoration: none; margin-bottom: 0.75rem;">
                Login to Checkout
              </a>
            {% endif %}

            <button class="btn btn-ghost" id="clear-cart" style="width: 100%;">
              Clear Cart
            </button>

            <div style="margin-top: 1.5rem; padding: 1rem; background: hsl(var(--muted) / 0.3); border-radius: 8px;">
              <div style="display: flex; align-items: start; gap: 0.75rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="hsl(var(--primary))" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <div>
                  <p style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem;">Secure Escrow</p>
                  <p style="font-size: 0.8125rem; color: hsl(var(--muted-foreground)); line-height: 1.4; margin: 0;">
                    All transactions protected by Monero 2-of-3 multisig escrow
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    {% else %}
      {# Empty Cart State #}
      <div class="card" style="text-align: center; padding: 4rem 2rem;">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="hsl(var(--muted-foreground))" stroke-width="1.5" style="margin: 0 auto 1.5rem;">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: hsl(var(--foreground)); margin-bottom: 0.5rem;">Your cart is empty</h2>
        <p style="color: hsl(var(--muted-foreground)); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
          Start exploring our marketplace to find products you love
        </p>
        <a href="/listings" class="btn btn-primary btn-lg" style="text-decoration: none;">
          Browse Marketplace
        </a>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/cart.js"></script>
{% endblock %}
