{% extends "base-marketplace.html" %}

{% block title %}Shopping Cart — NEXUS{% endblock %}

{% block content %}

<div class="container px-4 md:px-8 py-8 md:py-16">
    <!-- Breadcrumb -->
    <nav class="mb-8">
        <a href="/listings" class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors group">
            <svg class="lucide-sm group-hover:-translate-x-1 transition-transform" viewBox="0 0 24 24">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
            <span class="font-medium">Continue Shopping</span>
        </a>
    </nav>

    {% if cart_items and cart_items | length > 0 %}
    <div class="grid lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2 space-y-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl md:text-4xl font-bold">Shopping Cart</h1>
                <span class="text-muted-foreground">{{ cart_items | length }} item{% if cart_items | length > 1 %}s{% endif %}</span>
            </div>

            {% for item in cart_items %}
            <div class="card hover:ring-2 hover:ring-primary/20 transition-all">
                <div class="p-6">
                    <div class="flex gap-6">
                        <!-- Product Image (Larger) -->
                        <a href="/listings/{{ item.listing_id }}" class="flex-shrink-0 group">
                            <div class="relative overflow-hidden rounded-xl" style="width: 140px; height: 140px;">
                                {% if item.image_cid %}
                                <img
                                    src="/api/listings/{{ item.listing_id }}/images/{{ item.image_cid }}"
                                    alt="{{ item.title }}"
                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                                    onerror="this.parentElement.innerHTML='<div class=\'w-full h-full flex items-center justify-center bg-muted\'><svg class=\'lucide text-muted-foreground\' viewBox=\'0 0 24 24\' style=\'width: 2rem; height: 2rem;\'><rect width=\'18\' height=\'18\' x=\'3\' y=\'3\' rx=\'2\' ry=\'2\'/><circle cx=\'9\' cy=\'9\' r=\'2\'/><path d=\'m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21\'/></svg></div>'"
                                />
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center bg-muted">
                                    <svg class="lucide text-muted-foreground" viewBox="0 0 24 24" style="width: 2rem; height: 2rem;">
                                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                                        <circle cx="9" cy="9" r="2"/>
                                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                                    </svg>
                                </div>
                                {% endif %}
                            </div>
                        </a>

                        <!-- Product Info -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-4 mb-3">
                                <div class="flex-1">
                                    <a href="/listings/{{ item.listing_id }}" class="hover:text-primary transition-colors">
                                        <h3 class="font-semibold text-lg mb-1 line-clamp-2">{{ item.title }}</h3>
                                    </a>
                                    {% if item.category %}
                                    <span class="inline-block px-2 py-1 rounded-md text-xs font-medium bg-primary/10 text-primary">
                                        {{ item.category | title }}
                                    </span>
                                    {% endif %}
                                </div>

                                <!-- Remove Button -->
                                <form hx-delete="/cart/{{ item.id }}" hx-target="closest .card" hx-swap="outerHTML swap:1s" hx-confirm="Remove this item from cart?">
                                    <button type="submit" class="btn btn-ghost btn-icon text-muted-foreground hover:text-destructive transition-colors" title="Remove item">
                                        <svg class="lucide-sm" viewBox="0 0 24 24">
                                            <path d="M3 6h18"/>
                                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                            <line x1="10" x2="10" y1="11" y2="17"/>
                                            <line x1="14" x2="14" y1="11" y2="17"/>
                                        </svg>
                                    </button>
                                </form>
                            </div>

                            <!-- Price & Quantity -->
                            <div class="flex items-end justify-between gap-4 mt-4">
                                <div>
                                    <div class="text-2xl font-bold" style="color: hsl(var(--primary));">
                                        {{ item.price_xmr }} XMR
                                    </div>
                                    {% if item.price_usd %}
                                    <div class="text-sm text-muted-foreground">
                                        ≈ ${{ item.price_usd | round }} USD
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Quantity Controls -->
                                <div class="flex items-center gap-3 p-2 rounded-lg bg-muted/50 border border-border">
                                    <form hx-post="/cart/{{ item.id }}/decrease" hx-target="closest .card" hx-swap="outerHTML">
                                        <button type="submit" class="btn btn-ghost" style="height: 2rem; width: 2rem; padding: 0; min-width: unset;" {% if item.quantity <= 1 %}disabled{% endif %}>
                                            <svg class="lucide-sm" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                                                <line x1="5" y1="12" x2="19" y2="12"/>
                                            </svg>
                                        </button>
                                    </form>
                                    <span class="w-10 text-center font-semibold tabular-nums">{{ item.quantity }}</span>
                                    <form hx-post="/cart/{{ item.id }}/increase" hx-target="closest .card" hx-swap="outerHTML">
                                        <button type="submit" class="btn btn-ghost" style="height: 2rem; width: 2rem; padding: 0; min-width: unset;">
                                            <svg class="lucide-sm" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                                                <line x1="12" y1="5" x2="12" y2="19"/>
                                                <line x1="5" y1="12" x2="19" y2="12"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="card sticky" style="top: 6rem;">
                <div class="p-6 space-y-6">
                    <h2 class="text-2xl font-bold">Order Summary</h2>

                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Subtotal</span>
                            <div class="text-right">
                                <div class="font-semibold">{{ subtotal | round(precision=4) }} XMR</div>
                                {% if subtotal_usd %}
                                <div class="text-xs text-muted-foreground">≈ ${{ subtotal_usd | round }} USD</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Escrow Fee (2%)</span>
                            <div class="text-right">
                                <div class="font-semibold">{{ escrow_fee | round(precision=4) }} XMR</div>
                                {% if escrow_fee_usd %}
                                <div class="text-xs text-muted-foreground">≈ ${{ escrow_fee_usd | round }} USD</div>
                                {% endif %}
                            </div>
                        </div>

                        <div style="height: 1px; background-color: hsl(var(--border));"></div>

                        <div class="flex justify-between items-start">
                            <span class="text-xl font-bold">Total</span>
                            <div class="text-right">
                                <div class="text-2xl font-bold" style="color: hsl(var(--primary));">
                                    {{ total | round(precision=4) }} XMR
                                </div>
                                {% if total_usd %}
                                <div class="text-sm text-muted-foreground">
                                    ≈ ${{ total_usd | round }} USD
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="rounded-lg p-4 space-y-2" style="background: linear-gradient(135deg, hsl(var(--primary) / 0.1) 0%, hsl(var(--primary) / 0.05) 100%); border: 1px solid hsl(var(--primary) / 0.2);">
                            <div class="flex items-center gap-2">
                                <svg class="lucide-sm text-primary" viewBox="0 0 24 24">
                                    <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                                <p class="font-semibold text-sm">Secure 2/3 Multisig Escrow</p>
                            </div>
                            <p class="text-xs text-muted-foreground leading-relaxed">
                                Your payment will be held securely until you confirm delivery. Your keys, your control.
                            </p>
                        </div>
                    </div>

                    <a href="/checkout" class="btn btn-primary w-full btn-lg">
                        <span>Proceed to Checkout</span>
                        <svg class="lucide-sm ml-2" viewBox="0 0 24 24">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </a>

                    <div class="text-center pt-2">
                        <a href="/listings" class="text-sm text-muted-foreground hover:text-primary transition-colors inline-flex items-center gap-1 group">
                            <svg class="lucide-sm group-hover:-translate-x-0.5 transition-transform" viewBox="0 0 24 24" style="width: 0.875rem; height: 0.875rem;">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                            <span>Continue Shopping</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="flex flex-col items-center justify-center py-20 text-center">
        <div class="relative mb-8">
            <div class="h-32 w-32 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, hsl(var(--primary) / 0.2) 0%, hsl(var(--primary) / 0.05) 100%);">
                <svg class="lucide" viewBox="0 0 24 24" style="width: 4rem; height: 4rem; color: hsl(var(--primary));">
                    <path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                    <line x1="3" x2="21" y1="6" y2="6"/>
                    <path d="M16 10a4 4 0 0 1-8 0"/>
                </svg>
            </div>
            <div class="absolute top-0 left-0 w-full h-full rounded-full bg-primary/10 blur-2xl"></div>
        </div>
        <h2 class="text-3xl md:text-4xl font-bold mb-3">Your Cart is Empty</h2>
        <p class="text-muted-foreground text-lg mb-8 max-w-md">
            Start shopping and add products to your cart to get started with secure Monero payments
        </p>
        <a href="/listings" class="btn btn-primary btn-lg">
            <svg class="lucide-sm mr-2" viewBox="0 0 24 24">
                <circle cx="8" cy="21" r="1"/>
                <circle cx="19" cy="21" r="1"/>
                <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
            <span>Browse Products</span>
        </a>
    </div>
    {% endif %}
</div>

{% endblock %}
