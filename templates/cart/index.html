{% extends "base-marketplace.html" %}

{% block title %}Panier - NEXUS{% endblock %}

{% block content %}
<div class="cart-page-container">
  <div class="cart-page-content">

    {# Page Header #}
    <div class="cart-header">
      <h1 class="cart-title">Votre <span class="text-accent">Panier</span></h1>
      <p class="cart-subtitle">Vérifiez vos articles avant de procéder au paiement sécurisé avec escrow multisig.</p>
    </div>

    {% if cart and cart.items and cart.items | length > 0 %}
      <div class="cart-layout">

        {# Cart Items - Each item in its own card #}
        <div class="cart-items-section">
          {% for item in cart.items %}
          <div class="card cart-item-card" data-listing-id="{{ item.listing_id }}">
            <div class="cart-item-content">
              {# Product Info #}
              <div class="cart-item-info">
                <h3 class="cart-item-title">{{ item.title }}</h3>
                <p class="cart-item-vendor">
                  Vendeur: {{ item.vendor_username }}
                </p>
              </div>

              {# Price and Remove Button #}
              <div class="cart-item-actions">
                <span class="cart-item-price">{{ item.unit_price_xmr * item.quantity | float / 1000000000000 }} XMR</span>
                <button class="remove-item-btn" data-listing-id="{{ item.listing_id }}" aria-label="Supprimer">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        {# Order Summary Card #}
        <div class="cart-summary-section">
          <div class="card cart-summary-card">
            <div class="cart-summary-header">
              <h2 class="cart-summary-title">Récapitulatif</h2>
            </div>

            <div class="cart-summary-content">
              <div class="summary-lines">
                <div class="summary-line">
                  <span class="summary-label">Sous-total</span>
                  <span class="summary-value" id="cart-subtotal">{{ cart_total_xmr }} XMR</span>
                </div>
                <div class="summary-line">
                  <span class="summary-label">Frais d'escrow (3%)</span>
                  <span class="summary-value" id="cart-escrow-fee">Calculating...</span>
                </div>
                <div class="summary-divider"></div>
                <div class="summary-line summary-total">
                  <span class="summary-label-total">Total</span>
                  <span id="cart-total" class="summary-value-total">{{ cart_total_xmr }} XMR</span>
                </div>
              </div>

              {% if logged_in %}
                <a href="/checkout" class="btn-checkout">
                  Procéder au paiement
                </a>
              {% else %}
                <a href="/login?redirect=/checkout" class="btn-checkout">
                  Se connecter pour payer
                </a>
              {% endif %}

              <a href="/listings" class="btn-continue">
                Continuer vos achats
              </a>

              <div class="escrow-notice">
                <p class="escrow-description">
                  Protection escrow multisig 2/3. Vos fonds restent sous votre contrôle jusqu'à la finalisation de la transaction.
                </p>
              </div>
            </div>
          </div>
        </div>

      </div>
    {% else %}
      {# Empty Cart State #}
      <div class="card">
        <div class="cart-empty">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="cart-empty-icon">
            <circle cx="9" cy="21" r="1"/>
            <circle cx="20" cy="21" r="1"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
          </svg>
          <p class="cart-empty-text">Votre panier est vide</p>
          <a href="/listings" class="btn-continue">
            Explorer les listings
          </a>
        </div>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/cart.js"></script>
{% endblock %}
