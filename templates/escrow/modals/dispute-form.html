<!-- NEXUS Modal: Open Dispute -->
<div class="nexus-modal-overlay" id="dispute-modal" onclick="this.remove()">
  <div class="nexus-modal-dialog" onclick="event.stopPropagation()">
    <div class="nexus-modal-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        Open Dispute
      </h2>
      <button class="nexus-modal-close" onclick="document.getElementById('dispute-modal').remove()" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="nexus-modal-body">
      <!-- Warning Notice -->
      <div class="nexus-alert nexus-alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        <div>
          <strong>⚠️ Dispute Process</strong>
          <p>Opening a dispute will notify the neutral arbiter to review evidence and make a decision. Provide as much detail as possible.</p>
        </div>
      </div>

      <!-- Dispute Form -->
      <form id="dispute-form"
            hx-post="/api/escrow/{{ escrow_id }}/dispute"
            hx-ext="json-enc"
            hx-target="#dispute-result"
            hx-swap="innerHTML"
            hx-indicator="#dispute-spinner"
            hx-timeout="30000"
            hx-disabled-elt="find button[type='submit']">

        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}

        <!-- Dispute Reason -->
        <div class="nexus-form-group">
          <label for="reason" class="nexus-label">
            Reason for Dispute *
          </label>
          <textarea name="reason"
                    id="reason"
                    class="nexus-textarea"
                    rows="6"
                    placeholder="Describe the issue in detail (10-2000 characters)"
                    required
                    minlength="10"
                    maxlength="2000"
                    aria-describedby="reason-help"></textarea>
          <small id="reason-help" class="nexus-help-text">
            Include all relevant information: delivery status, quality issues, communication problems, etc. This will be reviewed by the arbiter.
          </small>
          <div class="nexus-char-count">
            <span id="char-count">0</span> / 2000 characters
          </div>
        </div>

        <!-- Evidence Upload (Future Enhancement) -->
        <div class="nexus-info-box">
          <h4>What Happens Next?</h4>
          <ol class="nexus-timeline-list">
            <li>Arbiter is notified and reviews your dispute</li>
            <li>Both parties may be contacted for additional information</li>
            <li>Arbiter makes a decision (typically within 7 days)</li>
            <li>Funds are released according to arbiter's decision</li>
          </ol>
        </div>

        <!-- Result Container -->
        <div id="dispute-result"></div>

        <!-- Actions -->
        <div class="nexus-modal-actions">
          <button type="button"
                  class="nexus-btn nexus-btn-ghost"
                  onclick="document.getElementById('dispute-modal').remove()">
            Cancel
          </button>
          <button type="submit"
                  class="nexus-btn nexus-btn-destructive">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Open Dispute
          </button>
          <div id="dispute-spinner" class="nexus-spinner htmx-indicator">
            <div class="nexus-spinner-circle"></div>
            <span>Submitting dispute...</span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/static/css/nexus-modal.css">

<script>
// Character counter
const textarea = document.getElementById('reason');
const charCount = document.getElementById('char-count');

textarea.addEventListener('input', function() {
  charCount.textContent = this.value.length;

  // Visual feedback for character limit
  if (this.value.length > 1900) {
    charCount.style.color = 'hsl(0, 85%, 60%)';
  } else {
    charCount.style.color = 'var(--nexus-muted-fg)';
  }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('dispute-modal');
    if (modal) modal.remove();
  }
}, { once: true });

// Handle HTMX response
document.getElementById('dispute-form').addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.successful) {
    if (window.notificationManager) {
      window.notificationManager.showToast(
        '⚖️ Dispute Opened',
        'Arbiter has been notified. You will be contacted if additional information is needed.',
        'warning',
        8000
      );
    }

    setTimeout(() => {
      document.getElementById('dispute-modal').remove();
      window.location.reload();
    }, 2000);
  } else {
    const errorMessage = event.detail.xhr.responseText || 'Failed to open dispute';
    if (window.notificationManager) {
      window.notificationManager.showToast(
        '❌ Dispute Failed',
        errorMessage,
        'error',
        8000
      );
    }
  }
});
</script>

<style>
.nexus-alert-error {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: hsl(0, 85%, 70%);
}

.nexus-alert-error strong {
  color: hsl(0, 85%, 60%);
}

.nexus-textarea {
  width: 100%;
  padding: var(--nexus-space-3) var(--nexus-space-4);
  background: rgba(10, 10, 10, 0.8);
  border: 1px solid hsl(0, 0%, 20%);
  border-radius: var(--nexus-radius-md);
  color: var(--nexus-fg);
  font-size: var(--nexus-text-sm);
  font-family: inherit;
  resize: vertical;
  transition: all var(--nexus-transition-base);
}

.nexus-textarea:focus {
  outline: none;
  border-color: var(--nexus-primary);
  box-shadow: 0 0 0 3px rgba(255, 26, 92, 0.1);
}

.nexus-char-count {
  text-align: right;
  font-size: var(--nexus-text-xs);
  color: var(--nexus-muted-fg);
  margin-top: var(--nexus-space-1);
  font-family: var(--nexus-font-mono);
}

.nexus-timeline-list {
  margin: 0;
  padding-left: var(--nexus-space-5);
  color: var(--nexus-muted-fg);
  font-size: var(--nexus-text-sm);
  line-height: 1.8;
}

.nexus-timeline-list li {
  margin-bottom: var(--nexus-space-2);
}
</style>
