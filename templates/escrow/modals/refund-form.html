<!-- NEXUS Modal: Refund Funds to Buyer -->
<div class="nexus-modal-overlay" id="refund-modal" onclick="this.remove()">
  <div class="nexus-modal-dialog" onclick="event.stopPropagation()">
    <div class="nexus-modal-header">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
        </svg>
        Refund Funds to Buyer
      </h2>
      <button class="nexus-modal-close" onclick="document.getElementById('refund-modal').remove()" aria-label="Close modal">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="nexus-modal-body">
      <!-- Warning Notice -->
      <div class="nexus-alert nexus-alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <div>
          <strong>ℹ️ Refund Process</strong>
          <p>This will return the escrow funds to the buyer. Requires 2-of-3 signatures (Vendor + Arbiter).</p>
        </div>
      </div>

      <!-- Refund Form -->
      <form id="refund-form"
            hx-post="/api/escrow/{{ escrow_id }}/refund"
            hx-ext="json-enc"
            hx-target="#refund-result"
            hx-swap="innerHTML"
            hx-indicator="#refund-spinner">

        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {% endif %}

        <!-- Buyer Address -->
        <div class="nexus-form-group">
          <label for="buyer_address" class="nexus-label">
            Buyer Monero Address *
          </label>
          <input type="text"
                 name="buyer_address"
                 id="buyer_address"
                 class="nexus-input nexus-input-monospace"
                 placeholder="4ABC...xyz (95 characters)"
                 required
                 pattern="^4[0-9A-Za-z]{94}$"
                 minlength="95"
                 maxlength="95"
                 aria-describedby="buyer-address-help">
          <small id="buyer-address-help" class="nexus-help-text">
            Monero testnet addresses start with '4' and are exactly 95 characters long.
          </small>
        </div>

        <!-- Transaction Details -->
        <div class="nexus-info-box">
          <h4>Transaction Details</h4>
          <dl class="nexus-details-list">
            <dt>Amount:</dt>
            <dd>{{ amount_xmr }} XMR</dd>

            <dt>Signatures Required:</dt>
            <dd>2-of-3 (Vendor + Arbiter)</dd>

            <dt>Status After Refund:</dt>
            <dd><span class="nexus-badge nexus-badge-secondary">Refunding</span></dd>
          </dl>
        </div>

        <!-- Result Container -->
        <div id="refund-result"></div>

        <!-- Actions -->
        <div class="nexus-modal-actions">
          <button type="button"
                  class="nexus-btn nexus-btn-ghost"
                  onclick="document.getElementById('refund-modal').remove()">
            Cancel
          </button>
          <button type="submit"
                  class="nexus-btn nexus-btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
            Refund {{ amount_xmr }} XMR
          </button>
          <div id="refund-spinner" class="nexus-spinner htmx-indicator">
            <div class="nexus-spinner-circle"></div>
            <span>Processing refund...</span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/static/css/nexus-modal.css">

<script>
// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('refund-modal');
    if (modal) modal.remove();
  }
}, { once: true });

// Handle HTMX response
document.getElementById('refund-form').addEventListener('htmx:afterRequest', function(event) {
  if (event.detail.successful) {
    if (window.notificationManager) {
      window.notificationManager.showToast(
        '↩️ Refund Initiated',
        'Transaction submitted successfully. Awaiting blockchain confirmation.',
        'success',
        5000
      );
    }

    setTimeout(() => {
      document.getElementById('refund-modal').remove();
      window.location.reload();
    }, 2000);
  } else {
    const errorMessage = event.detail.xhr.responseText || 'Failed to process refund';
    if (window.notificationManager) {
      window.notificationManager.showToast(
        '❌ Refund Failed',
        errorMessage,
        'error',
        8000
      );
    }
  }
});
</script>

<style>
.nexus-alert-info {
  background: rgba(0, 217, 255, 0.1);
  border: 1px solid rgba(0, 217, 255, 0.3);
  color: hsl(190, 100%, 70%);
}

.nexus-alert-info strong {
  color: hsl(190, 100%, 55%);
}

.nexus-badge-secondary {
  background: rgba(124, 58, 237, 0.2);
  color: hsl(270, 60%, 65%);
  border: 1px solid hsl(270, 60%, 50%);
}
</style>
