<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multisig Dashboard - NEXUS</title>
    <meta name="description" content="Monitor all your 2-of-3 multisig escrow transactions">

    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/marketplace-variables.css">

    <style>
        /* Layout */
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 8rem 1.5rem 2rem; }
        .dashboard-header { margin-bottom: 3rem; }
        .dashboard-title { font-size: 2.5rem; font-weight: 300; margin-bottom: 0.5rem; color: hsl(var(--foreground)); }
        .dashboard-subtitle { font-size: 1.125rem; color: hsl(var(--muted-foreground)); font-weight: 300; }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .stat-card { background: linear-gradient(135deg, hsl(var(--card)) 0%, rgba(255, 26, 92, 0.05) 100%); border: 1px solid hsl(var(--border)); border-radius: 0.75rem; padding: 1.5rem; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3); }
        .stat-icon { width: 3rem; height: 3rem; border-radius: 50%; background: linear-gradient(135deg, rgba(255, 26, 92, 0.2) 0%, rgba(138, 43, 226, 0.2) 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; }
        .stat-label { font-size: 0.875rem; color: hsl(var(--muted-foreground)); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: hsl(var(--accent)); font-family: monospace; }

        /* Filter Tabs */
        .filter-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .filter-tab { padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: 1px solid hsl(var(--border)); background: hsl(var(--card)); color: hsl(var(--foreground)); cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .filter-tab:hover { border-color: hsl(var(--accent)); }
        .filter-tab.active { background: hsl(var(--accent)); color: #1A1A1A; border-color: hsl(var(--accent)); }

        /* Escrows Grid */
        .escrows-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.5rem; }
        .escrow-card { background: hsl(var(--card)); border: 1px solid hsl(var(--border)); border-radius: 0.75rem; padding: 1.5rem; transition: all 0.3s; position: relative; overflow: hidden; }
        .escrow-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, hsl(var(--accent)) 0%, rgba(138, 43, 226, 0.6) 100%); }
        .escrow-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3); border-color: hsla(var(--accent), 0.5); }

        .escrow-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; }
        .escrow-id { font-family: monospace; font-size: 0.875rem; color: hsl(var(--muted-foreground)); }
        .copy-btn { padding: 0.25rem 0.5rem; border-radius: 0.25rem; background: transparent; border: 1px solid hsl(var(--border)); color: hsl(var(--foreground)); cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
        .copy-btn:hover { background: hsl(var(--accent)); color: #1A1A1A; border-color: hsl(var(--accent)); }

        .order-link { color: hsl(var(--accent)); text-decoration: none; font-weight: 500; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.375rem; }
        .order-link:hover { text-decoration: underline; }

        .participants { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin: 1.5rem 0; }
        .participant { text-align: center; padding: 0.75rem; background: hsla(var(--muted), 0.3); border-radius: 0.5rem; }
        .participant-icon { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .participant-role { font-size: 0.625rem; text-transform: uppercase; color: hsl(var(--muted-foreground)); letter-spacing: 0.05em; }
        .participant-name { font-size: 0.875rem; font-weight: 500; color: hsl(var(--foreground)); margin-top: 0.25rem; }

        .amount-section { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: linear-gradient(135deg, rgba(255, 26, 92, 0.05) 0%, rgba(138, 43, 226, 0.05) 100%); border-radius: 0.5rem; margin-bottom: 1rem; }
        .amount-label { font-size: 0.75rem; color: hsl(var(--muted-foreground)); text-transform: uppercase; }
        .amount-value { font-size: 1.5rem; font-weight: 700; color: hsl(var(--accent)); font-family: monospace; }

        .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-pending { background-color: #eab308; color: #1A1A1A; }
        .status-funded { background-color: #22c55e; color: #1A1A1A; }
        .status-released { background-color: #00d9ff; color: #1A1A1A; }
        .status-disputed { background-color: #ff6b35; color: #1A1A1A; }
        .status-refunded { background-color: #ef4444; color: #1A1A1A; }

        .multisig-progress { margin: 1rem 0; }
        .progress-label { font-size: 0.75rem; color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem; }
        .progress-bar { height: 0.5rem; background: hsla(var(--muted), 0.5); border-radius: 9999px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, hsl(var(--accent)) 0%, rgba(138, 43, 226, 0.8) 100%); transition: width 0.3s; }

        .action-btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.5rem; background: hsl(var(--accent)); color: #1A1A1A; text-decoration: none; font-weight: 500; font-size: 0.875rem; width: 100%; margin-top: 1rem; transition: opacity 0.2s; }
        .action-btn:hover { opacity: 0.85; }

        /* Empty State */
        .empty-state { text-align: center; padding: 4rem 2rem; }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-title { font-size: 1.5rem; font-weight: 500; margin-bottom: 0.5rem; color: hsl(var(--foreground)); }
        .empty-text { color: hsl(var(--muted-foreground)); margin-bottom: 2rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-title { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .escrows-grid { grid-template-columns: 1fr; }
            .participants { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    {% include "header.html" %}

    <main class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Multisig <span style="color: hsl(var(--accent));">Dashboard</span></h1>
            <p class="dashboard-subtitle">Monitor all your 2-of-3 multisig escrow transactions</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üîí</div>
                <div class="stat-label">Active Escrows</div>
                <div class="stat-value" id="stat-active">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Total Locked XMR</div>
                <div class="stat-value" id="stat-locked">0.000000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö°</div>
                <div class="stat-label">Pending Actions</div>
                <div class="stat-value" id="stat-pending">0</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All Escrows</button>
            <button class="filter-tab" data-filter="buyer">As Buyer</button>
            <button class="filter-tab" data-filter="vendor">As Vendor</button>
            <button class="filter-tab" data-filter="arbiter">As Arbiter</button>
        </div>

        <!-- Escrows Grid -->
        <div class="escrows-grid" id="escrows-grid">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-icon">üîê</div>
            <h2 class="empty-title">No Escrows Found</h2>
            <p class="empty-text">You don't have any multisig escrows yet.</p>
            <a href="/listings" class="action-btn" style="max-width: 300px; margin-left: auto; margin-right: auto;">
                Browse Listings
            </a>
        </div>
    </main>

    <script src="/static/js/lucide.min.js"></script>
    <script src="/static/js/base.js"></script>
    <script>
        let allEscrows = [];
        let currentFilter = 'all';

        // Load escrows on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadEscrows();

            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterEscrows();
                });
            });

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        async function loadEscrows() {
            try {
                const response = await fetch('/api/user/escrows');
                if (!response.ok) {
                    console.error('Failed to load escrows');
                    return;
                }

                allEscrows = await response.json();
                updateStats();
                renderEscrows(allEscrows);
            } catch (error) {
                console.error('Error loading escrows:', error);
            }
        }

        function updateStats() {
            const activeCount = allEscrows.filter(e => e.status !== 'released' && e.status !== 'refunded').length;
            const totalLocked = allEscrows
                .filter(e => e.status === 'funded' || e.status === 'disputed')
                .reduce((sum, e) => sum + e.amount, 0) / 1000000000000;
            const pendingActions = allEscrows.filter(e => e.status === 'pending' || e.multisig_phase === 'awaiting_signatures').length;

            document.getElementById('stat-active').textContent = activeCount;
            document.getElementById('stat-locked').textContent = totalLocked.toFixed(6);
            document.getElementById('stat-pending').textContent = pendingActions;
        }

        function filterEscrows() {
            if (currentFilter === 'all') {
                renderEscrows(allEscrows);
            } else {
                const filtered = allEscrows.filter(e => e.user_role.toLowerCase() === currentFilter);
                renderEscrows(filtered);
            }
        }

        function renderEscrows(escrows) {
            const grid = document.getElementById('escrows-grid');
            const emptyState = document.getElementById('empty-state');

            if (escrows.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = escrows.map(escrow => {
                const amountXmr = (escrow.amount / 1000000000000).toFixed(6);
                const statusClass = `status-${escrow.status}`;
                const statusText = getStatusText(escrow.status);
                const progressPercent = getProgressPercent(escrow.multisig_phase);

                return `
                    <div class="escrow-card">
                        <div class="escrow-header">
                            <div>
                                <div class="escrow-id">Escrow #${escrow.id.substring(0, 8)}</div>
                                <a href="/orders/${escrow.order_id}" class="order-link">
                                    Order #${escrow.order_id.substring(0, 8)} ‚Üí
                                </a>
                            </div>
                            <button class="copy-btn" onclick="copyEscrowId('${escrow.id}')">üìã Copy ID</button>
                        </div>

                        <div class="participants">
                            <div class="participant ${escrow.user_role === 'Buyer' ? 'highlight' : ''}">
                                <div class="participant-icon">üë§</div>
                                <div class="participant-role">Buyer</div>
                                ${escrow.user_role === 'Buyer' ? '<div class="participant-name">You</div>' : ''}
                            </div>
                            <div class="participant ${escrow.user_role === 'Vendor' ? 'highlight' : ''}">
                                <div class="participant-icon">üè™</div>
                                <div class="participant-role">Vendor</div>
                                ${escrow.user_role === 'Vendor' ? '<div class="participant-name">You</div>' : ''}
                            </div>
                            <div class="participant ${escrow.user_role === 'Arbiter' ? 'highlight' : ''}">
                                <div class="participant-icon">‚öñÔ∏è</div>
                                <div class="participant-role">Arbiter</div>
                                ${escrow.user_role === 'Arbiter' ? '<div class="participant-name">You</div>' : ''}
                            </div>
                        </div>

                        <div class="amount-section">
                            <div>
                                <div class="amount-label">Escrowed Amount</div>
                                <div class="amount-value">${amountXmr} XMR</div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>

                        <div class="multisig-progress">
                            <div class="progress-label">Multisig Phase: ${formatPhase(escrow.multisig_phase)}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <a href="/escrow/${escrow.id}" class="action-btn">
                            View Details ‚Üí
                        </a>
                    </div>
                `;
            }).join('');

            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function getStatusText(status) {
            const map = {
                'pending': '‚è≥ PENDING',
                'funded': 'üí∞ FUNDED',
                'released': '‚úÖ RELEASED',
                'disputed': '‚ö†Ô∏è DISPUTED',
                'refunded': '‚Ü©Ô∏è REFUNDED'
            };
            return map[status] || status.toUpperCase();
        }

        function getProgressPercent(phase) {
            const map = {
                // Legacy mappings
                'init': 10,
                'prepared': 33,
                'awaiting_signatures': 50,
                'finalized': 75,
                'funded': 100,
                'released': 100,
                // Server MultisigPhase mappings
                'NotStarted': 10,
                'Preparing': 33,
                'Exchanging': 60,
                'Ready': 80,
                'Failed': 0
            };
            return map[phase] || 0;
        }

        function copyEscrowId(id) {
            navigator.clipboard.writeText(id);
            // Could add a toast notification here
            console.log('Copied:', id);
        }

        function formatPhase(phase) {
            const mapping = {
                // Legacy
                'init': 'INIT',
                'prepared': 'PREPARED',
                'awaiting_signatures': 'AWAITING SIGNATURES',
                'finalized': 'FINALIZED',
                'funded': 'FUNDED',
                'released': 'RELEASED',
                // Server-side states
                'NotStarted': 'INIT',
                'Preparing': 'PREPARING',
                'Exchanging': 'EXCHANGING',
                'Ready': 'READY',
                'Failed': 'FAILED'
            };
            return mapping[phase] || (phase || '').toString().replace(/_/g, ' ').toUpperCase();
        }
    </script>
</body>
</html>
