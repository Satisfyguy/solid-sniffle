{% extends "base.html" %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/reputation.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Vendor Header -->
    <div class="vendor-header mb-8">
        <h1 class="text-3xl font-bold mb-2">{{ vendor.username }}</h1>
        <p class="text-gray-400">Vendor since {{ vendor.created_at | date(format="%B %Y") }}</p>
    </div>

    <!-- Verification Badge -->
    <div id="verification-badge" class="mb-6">
        <div class="verification-badge">
            <span class="badge-icon">⏳</span>
            <span class="badge-text">Verifying signatures...</span>
        </div>
    </div>

    <!-- Reputation Stats -->
    <div class="reputation-stats">
        <div class="stat-card">
            <div class="stat-value">{{ stats.average_rating | round(precision=1) }}</div>
            <div class="stat-label">Average Rating</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_reviews }}</div>
            <div class="stat-label">Total Reviews</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="verified-count">-</div>
            <div class="stat-label">Verified Reviews</div>
        </div>
    </div>

    <!-- Rating Distribution -->
    <div class="rating-distribution mb-8">
        <h3 class="text-xl font-semibold mb-4">Rating Distribution</h3>
        {% for i in range(end=5) %}
        {% set rating = 5 - i %}
        {% set count = stats.rating_distribution[rating - 1] %}
        {% set percentage = count * 100 / stats.total_reviews if stats.total_reviews > 0 else 0 %}
        <div class="rating-bar">
            <div class="rating-label">{{ rating }} ★</div>
            <div class="rating-bar-bg">
                <div class="rating-bar-fill" style="width: {{ percentage }}%"></div>
            </div>
            <div class="rating-count">{{ count }}</div>
        </div>
        {% endfor %}
    </div>

    <!-- Reviews List -->
    <div class="reviews-section">
        <h2 class="text-2xl font-bold mb-4">Customer Reviews</h2>
        
        <div id="reviews-list">
            {% for review in reviews %}
            <div class="review-card" data-review-id="{{ review.id }}">
                <div class="review-header">
                    <div class="review-rating">
                        {% for i in range(end=5) %}
                        <span class="star {% if i < review.rating %}filled{% else %}empty{% endif %}">★</span>
                        {% endfor %}
                    </div>
                    <div class="review-date">{{ review.timestamp | date(format="%B %d, %Y") }}</div>
                </div>
                
                {% if review.comment %}
                <div class="review-comment">{{ review.comment }}</div>
                {% endif %}
                
                <div class="review-meta">
                    <span>TX: {{ review.txid | truncate(length=16) }}</span>
                    <span class="review-verified-badge" data-review-index="{{ loop.index0 }}">
                        <span class="loading-spinner"></span> Verifying...
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- IPFS Export (Vendor Only) -->
    {% if is_vendor_owner %}
    <div class="mt-8">
        <button 
            hx-post="/api/reputation/export" 
            hx-vals='{"vendor_id": "{{ vendor.id }}", "csrf_token": "{{ csrf_token }}"}'
            hx-target="#export-result"
            hx-swap="innerHTML"
            class="btn btn-primary">
            Export to IPFS
        </button>
        <div id="export-result" class="mt-4"></div>
    </div>
    {% endif %}
</div>

<script type="module">
    import { initWasm, verifyReputation, displayVerificationBadge } from '/static/js/reputation-verify.js';

    async function verifyVendorReputation() {
        try {
            // Fetch reputation data
            const response = await fetch('/api/reputation/{{ vendor.id }}');
            const reputation = await response.json();

            // Verify all signatures
            const result = await verifyReputation(reputation);

            // Display badge
            displayVerificationBadge('verification-badge', result);

            // Update verified count
            document.getElementById('verified-count').textContent = result.valid_signatures;

            // Update individual review badges
            for (let i = 0; i < reputation.reviews.length; i++) {
                const badge = document.querySelector(`[data-review-index="${i}"]`);
                if (badge) {
                    const isValid = i < result.valid_signatures;
                    badge.innerHTML = isValid 
                        ? '<span style="color: #10b981;">✅ Verified</span>'
                        : '<span style="color: #ef4444;">⚠️ Invalid</span>';
                }
            }
        } catch (error) {
            console.error('Verification failed:', error);
            document.getElementById('verification-badge').innerHTML = 
                '<div class="verification-badge unverified"><span class="badge-icon">❌</span><span class="badge-text">Verification Error</span></div>';
        }
    }

    // Auto-verify on page load
    window.addEventListener('DOMContentLoaded', verifyVendorReputation);
</script>
{% endblock %}
